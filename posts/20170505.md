---
date: "2017-05-05T13:36:25+09:00"
draft: false
title: "RxSwiftã®Schedulersã¨æˆ¯ã‚Œã‚‹"
slug: "understanding-schedulers"
tags: ["Swift", "RxSwift"]
---

iOS ã®ã‚¢ãƒ—ãƒªé–‹ç™ºã‚’å§‹ã‚ã¦ 1 å¹´ãŒçµŒéã—ã¾ã—ãŸï¼RxSwift ã¨ã®ä»˜ãåˆã„ã‚‚ 1 å¹´ãŒçµŒéã—ã¾ã—ãŸï¼æœ€è¿‘ã¯ä»•äº‹ã§å†ã³ Android ã®æ‹…å½“ã«ãªã‚Šã¾ã—ãŸï¼

ã“ã®è¨˜äº‹ã¯ RxSwift ã¨ Schedulers ã«ã¤ã„ã¦æ›¸ãã¾ã—ãŸï¼GCD ã®è©±ã¯å‡ºã¦æ¥ã¾ã›ã‚“ã®ã§çœŸå‰£ã«å‹‰å¼·ã—ãŸæ–¹ã«ã¯ä»¥ä¸‹ã®è§£èª¬ãŒã¨ã¦ã‚‚ç´ æ™´ã‚‰ã—ã„ã§ã™ï¼

- [8.2 Grand Central Dispatch Â· mixi-inc/iOSTraining Wiki](https://github.com/mixi-inc/iOSTraining/wiki/8.2-Grand-Central-Dispatch)

---

## Observable ã¨ã‚¹ãƒ¬ãƒƒãƒ‰

Swift ã¯ 3.1 ã§ã™ï¼

ã¾ãšï¼ŒRxSwift ã§ã¦ãã¨ã†ãª Observable ã‚’ä½œã‚Šã¾ã™ï¼

```swift
let observable = Observable<String>.create { observer -> Disposable in
  observer.onNext("YO!ğŸ˜")
  observer.onCompleted()
}
```

```swift
observable.subscribe(onNext: { (message: String) in
  print(message)
})
```

```txt
YO!ğŸ˜
```

æ¬¡ã«ï¼Œ5 ç§’å¾Œã«ã€ŒYO!ã€ã‚’å—ã‘å–ã‚‹ã‚ˆã†ã« Observable ã‚’å¤‰æ›´ã—ã¾ã™ï¼

```Swift
let observable = Observable<String>.create { observer -> Disposable in
  Thread.sleep(forTimeInterval: 5) // Blocking
  observer.onNext("YO!ğŸ˜")
  observer.onCompleted()
  return Disposables.create()
}
```

Observable ã®å‡¦ç†ã¯ï¼Œé€šå¸¸ã¯`subscribe`ã‚’å‘¼ã³å‡ºã—ãŸã‚¹ãƒ¬ãƒƒãƒ‰ã§å®Ÿè¡Œã•ã‚Œã¾ã™ï¼
ãªã®ã§`Thread.sleep`ã¯ main ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’ãƒ–ãƒ­ãƒƒã‚¯ã—ã¦ã„ã¾ã™ï¼main ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’ãƒ–ãƒ­ãƒƒã‚¯ã™ã‚‹ã®ã¯ã‚¤ã‚±ãªã„ã“ã¨ãªã®ã§ï¼Œæ˜ç¤ºçš„ã«åˆ¥ã®ã‚¹ãƒ¬ãƒƒãƒ‰ã§å‡¦ç†ã™ã‚‹ã‚ˆã†ã«å¤‰æ›´ã—ã¾ã™ï¼

```swift
let observable = Observable<String>.create { observer -> Disposable in

  DispatchQueue.global(qos: .default).async {

    Thread.sleep(forTimeInterval: 5) // ...zzZ

    observer.onNext("YO!ğŸ˜")
    observer.onCompleted()
  }
  return Disposables.create()
}
```

ã€ŒYO!ã€ãŒã©ã®ã‚¹ãƒ¬ãƒƒãƒ‰ã‹ã‚‰æ¥ã¦ã„ã‚‹ã®ã‹çŸ¥ã‚ŠãŸã„ã®ã§ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ã‚’ä½œã£ã¦`subscribe`ã™ã‚‹å´ã‚’å°‘ã—å¤‰æ›´ã—ã¾ã™ï¼

```swift
func which() -> String {
  return Thread.isMainThread ? "main" : "background"
}
```

```swift
observable.subscribe(onNext: { (message: String) in
  print("\(message) on \(which())")
})
```

```txt
YO!ğŸ˜ on background
```

ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã‹ã‚‰ã€ŒYO!ã€ãŒå±Šãã¾ã—ãŸï¼

main ã‚¹ãƒ¬ãƒƒãƒ‰ä»¥å¤–ã‹ã‚‰ UI ã«è§¦ã‚ã†ã¨ã™ã‚‹ã¨ System ã«æ€’ã‚‰ã‚Œã¦ã—ã¾ã„ã¾ã™ï¼ãªã®ã§åˆ¥ã‚¹ãƒ¬ãƒƒãƒ‰ã§çœ ã£ã¦ã‹ã‚‰ã€ŒYO!ã€ã®é€ä¿¡ã ã‘ã‚’ main ã‚¹ãƒ¬ãƒƒãƒ‰ã§è¡Œã†ã‚ˆã†ã«å¤‰æ›´ã—ã¾ã™ï¼

```swift
let observable = Observable<String>.create { observer -> Disposable in

  DispatchQueue.global(qos: .default).async {

    Thread.sleep(forTimeInterval: 5)

    DispatchQueue.main.async {
      observer.onNext("YO!ğŸ˜")
      observer.onCompleted()
    }
  }
  return Disposables.create()
}
```

```txt
YO!ğŸ˜ on main
```

ã†ã¾ãã„ãã¾ã—ãŸï¼ã“ã‚Œã§ãƒãƒ³ãƒ–ãƒ­ãƒƒã‚­ãƒ³ã‚° YO!YO!ãŒå¯èƒ½ã«ãªã‚Šã¾ã—ãŸï¼

ã•ã¦ï¼Œã“ã“ã¾ã§ã®ã€ŒYO!ã€ã‚’æŒ¯ã‚Šè¿”ã£ã¦ã¿ã¾ã™ï¼

```swift
let observable = Observable<String>.create { observer -> Disposable in

  observer.onNext("YO!ğŸ˜") // where subscribe() is called

  DispatchQueue.global(qos: .default).async {

    Thread.sleep(forTimeInterval: 5)
    observer.onNext("YO!ğŸ˜") // background

    DispatchQueue.main.async {
      observer.onNext("YO!ğŸ˜") // main
      observer.onCompleted()
    }
  }
  return Disposables.create()
}
```

```txt
YO!ğŸ˜ on main
YO!ğŸ˜ on background
YO!ğŸ˜ on main
```

ã„ã„æ„Ÿã˜ã§ã™ï¼

## Schedulers

æ¬¡ã¯ã„ã‚ˆã„ã‚ˆ Scheduler ã‚’ä½¿ã„ã¾ã™ï¼Observable ã®`observeOn`ã«`MainScheduler`ã‚’æŒ‡å®šã—ã¾ã™ï¼

```swift
observable
  .observeOn(MainScheduler.instance)
  .subscribe(onNext: { (message: String) in
    print("\(message) (Here is \(which()))")
  })
```

```txt
YO!ğŸ˜ (Here is main)
YO!ğŸ˜ (Here is main)
YO!ğŸ˜ (Here is main)
```

`subscribe`ã®ä¸­ãŒå…¨ã¦ main ã‚¹ãƒ¬ãƒƒãƒ‰ã§å®Ÿè¡Œã•ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸï¼`MainScheduler`ã‚’æŒ‡å®šã—ãŸãŠã‹ã’ã§`DispatchQueue.main.async`ã¯ä¸è¦ã«ãªã‚Šã¾ã—ãŸï¼

ã€ŒYO!ã€ãŒã©ã“ã‹ã‚‰æ¥ã¦ã„ã‚‹ã®ã‹ã‚ã‹ã‚‰ãªããªã£ã¦ã—ã¾ã£ãŸã®ã§å°‘ã—å¤‰æ›´ã‚’åŠ ãˆã¾ã™ï¼

```swift
let observable = Observable<String>.create { observer -> Disposable in

  observer.onNext("YO!ğŸ˜ from \(which()).")

  DispatchQueue.global(qos: .default).async {

    Thread.sleep(forTimeInterval: 5)

    observer.onNext("YO!ğŸ˜ from \(which()).")
    observer.onCompleted()
  }
  return Disposables.create()
}
```

```txt
YO!ğŸ˜ from main. (Here is main)
YO!ğŸ˜ from background. (Here is main)
```

`observeOn`ã®æŒ¯ã‚‹èˆã„ãŒã‚ã‹ã‚Šã¾ã—ãŸï¼

æ¬¡ã«ï¼Œ`subscribeOn`ã§ Observable ã®å‡¦ç†ã‚’å®Ÿè¡Œã™ã‚‹ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’æŒ‡å®šã—ã¾ã™ï¼å…ˆã»ã©è¿°ã¹ãŸé€šã‚Šï¼ŒObservable ã®å‡¦ç†ã¯ï¼Œé€šå¸¸ã¯`subscribe`ã‚’å‘¼ã³å‡ºã—ãŸã‚¹ãƒ¬ãƒƒãƒ‰ã§å®Ÿè¡Œã•ã‚Œã¾ã™ï¼
ã—ã‹ã—`subscribeOn`ã‚’ä½¿ã†ã¨ã“ã‚Œã‚’å¤‰æ›´ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ï¼

```swift
observable
  .subscribeOn(ConcurrentDispatchQueueScheduler(qos: .default))
  .observeOn(MainScheduler.instance)
  .subscribe(onNext: { (message: String) in
    print("\(message) (Here is \(which()))")
  })
```

```txt
YO!ğŸ˜ from background. (Here is main)
YO!ğŸ˜ from background. (Here is main)
```

ã‚¹ãƒªãƒ¼ãƒ—ã®å‡¦ç†ã‚’ DispatchQueue ã§æŒ‡å®šã™ã‚‹å¿…è¦ãŒç„¡ããªã‚Šã¾ã™ã®ã§ï¼ŒObservable ã¯ã“ã†ãªã‚Šã¾ã™ï¼

```swift
let observable = Observable<String>.create { observer -> Disposable in
  Thread.sleep(forTimeInterval: 5)
  observer.onNext("YO!ğŸ˜ from \(which()).")
  observer.onCompleted()
  return Disposables.create()
}
```

ã“ã‚Œã¯å†’é ­ã«å‡ºã¦æ¥ãŸ Observable ã§ã™ï¼Schedulers ã‚’åˆ©ç”¨ã™ã‚Œã°ç°¡å˜ã«ãƒãƒ³ãƒ–ãƒ­ãƒƒã‚­ãƒ³ã‚° YO!YO!ãŒå‡ºæ¥ã¾ã™ï¼ä»¥ä¸Šã§ã™ï¼

ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã¯[Gist](https://gist.github.com/chooblarin/a041328422870581c616f32717d80393) ã«ç½®ã„ã¦ãŠãã¾ã™ï¼

## å‚è€ƒ

- [RxSwift/Schedulers.md at master Â· ReactiveX/RxSwift](https://github.com/ReactiveX/RxSwift/blob/master/Documentation/Schedulers.md)
- [RxSwift For Dummies ğŸ¥ Part 2](https://swiftpearls.com/RxSwift-for-dummies-2-Operators.html)
