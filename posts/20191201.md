---
date: "2019-12-01T00:00:00+00:00"
title: "2019å¹´ã®Promise"
draft: false
slug: "promise-in-2019"
tags: ["JavaScript"]
---

ã“ã®è¨˜äº‹ã¯[ãƒ•ãƒ©ãƒ¼ Advent Calendar 2019](https://adventar.org/calendars/4155)ã® 1 æ—¥ç›®ã®è¨˜äº‹ã§ã™ã€‚

ä»Šå¹´ã‚‚ JavaScript (TypeSctipt) ã‚’ãŸãã•ã‚“æ›¸ãã¾ã—ãŸã€‚

JavaScript ã«ã¯ ECMAScript ã¨ã„ã†æ¨™æº–ä»•æ§˜ãŒã‚ã‚Šã¾ã™ãŒï¼Œè¿‘å¹´ã§ã¯ TC39 ã«ã‚ˆã£ã¦æ¯å¹´æ–°ã—ã„æ©Ÿèƒ½ãŒè¿½åŠ ã•ã‚Œã¦ã„ã¾ã™ã€‚è­°è«–ã®ãƒ—ãƒ­ã‚»ã‚¹ã¯å¸¸ã«ã‚ªãƒ¼ãƒ—ãƒ³ã«ãªã£ã¦ã„ã‚‹ã®ã§èª°ã§ã‚‚é–²è¦§ã§ãã¾ã™ [\*](https://github.com/tc39)ã€‚

ãã—ã¦ä»Šå›ã¯ JavaScript ã®"Promise"ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã—ã¦è¿‘æ³ã‚’è§£èª¬ã—ã¾ã™ã€‚

## Promise ã§éåŒæœŸãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°

Promise ã¯ ES2015 (ES6)ã§æ­£å¼ã«å°å…¥ã•ã‚Œã¾ã—ãŸãŒï¼Œãã‚Œä»¥å‰ã«ã‚‚ JavaScript ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ã®éåŒæœŸå‡¦ç†ã®ä¸­å¿ƒã«ã„ã¾ã—ãŸã€‚

ã¾ãšã¯ Promise ã«ã¤ã„ã¦ç°¡å˜ã«å¾©ç¿’ã—ã¾ã—ã‚‡ã†ã€‚ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã§ Promise ã‚’ç”Ÿæˆã™ã‚‹ä¸€èˆ¬çš„ãªå½¢å¼ã®ä¾‹ã‚’ä»¥ä¸‹ã«ç¤ºã—ã¾ã™ã€‚

```js
const promise = new Promise((resolve, reject) => {
  doSomething(x => {
    if (x) {
      // æˆåŠŸ
      resolve(x);
    } else {
      reject(new Error("å¤±æ•—ğŸ˜¢"));
    }
  });
});


promise
  .then(result => { ... })
  .catch(error => { ... });
```

`doSomething` ã¯ä½•ã‚‰ã‹ã®éåŒæœŸå‡¦ç†ã‚’è¡Œã„ï¼Œã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã«ã‚ˆã£ã¦çµæœã‚’å¾—ã‚‹é–¢æ•°ã§ã™ã€‚ç„¡äº‹ã«çµæœãŒå¾—ã‚‰ã‚ŒãŸã¨ãã¯ `resolve()` ã‚’ä½¿ã„ã¾ã™ã€‚ã‚‚ã—ã‚‚çµæœãŒå¾—ã‚‰ã‚Œãªã‹ã£ãŸã¨ãã¯ `reject()`ã‚’ä½¿ã„ã¾ã™ã€‚

Promise ã«ã¯"pending", "fulfilled", "rejected" ã® 3 ã¤ã®çŠ¶æ…‹ãŒå­˜åœ¨ã—ã¾ã™ã€‚å…ˆã»ã©ã®ä¾‹ã§ï¼Œ`resolve()` ã‹ `reject()` ã‚’å‘¼ã³ã ã™å‰ã®çŠ¶æ…‹ã¯ **pending** çŠ¶æ…‹ã§ã™ã€‚å‘¼ã³å‡ºã—ãŸã‚ã¨ã¯ **fulfilled** ã‹ **rejected** ã®ã„ãšã‚Œã‹ã®çŠ¶æ…‹ã«ãªã‚Šã¾ã™ï¼ˆã“ã‚Œã‚’ **Settled** ã¨å‘¼ã³ã¾ã™ï¼‰ã€‚

<img src="https://user-images.githubusercontent.com/3143302/69895358-261eb400-1371-11ea-9a11-7c88b1a6226d.png" alt="promise has 3 states" style="display:block;margin:0 auto;width:95%;max-width:320px;">

Promise ã¯å¿…ãš 3 ã¤ã®ã†ã¡ã„ãšã‚Œã‹çŠ¶æ…‹ã‚’ã¨ã‚Šã¾ã™ãŒï¼ŒSettled ã«ãªã‚‰ãªã„å ´åˆã‚‚ã‚ã‚Šã¾ã™ã€‚ä¾‹ãˆã°ï¼Œä»¥ä¸‹ã® Promise ã¯æ°¸ä¹…ã« pending çŠ¶æ…‹ã§ã™ã€‚

```js
const p = new Promise(() => {});
```

## `.finally()`

ES2018 ã§ã¯ `Promise.prototype.finally()` ãŒå°å…¥ã•ã‚Œã¦ã„ã¾ã™ã€‚

```js
promise
  .then(result => { ... })
  .catch(error => { ... })
  .finally(() => {
    // å¾Œå§‹æœ«ã‚’ã“ã“ã«æ›¸ã
  });
```

`.finally()`ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯é–¢æ•°ã¯ï¼Œfulfilled ã‹ rejected ã‹ã«é–¢ã‚ã‚‰ãšå®Ÿè¡Œã•ã‚Œã¾ã™ã€‚

## è¤‡æ•°ã® Promise ã‚’æ“ã‚‹ `Promise.all` ã¨ `Promise.race`

ES2015 ã§ã¯ï¼Œ è¤‡æ•°ã® Promise ã‚’æ“ä½œã™ã‚‹ API `Promise.all` ã¨ `Promise.race` ã® 2 ã¤ãŒå°å…¥ã•ã‚Œã¾ã—ãŸã€‚

- `Promise.all`ï¼šå…¨ã¦ã® Promise ãŒ fulfilled ã¨ãªã£ãŸçµæœ
- `Promise.race`ï¼šã„ãšã‚Œã‹ã® Promise ã®ã†ã¡æœ€åˆã« Settled ã¨ãªã£ãŸçµæœ

`Promise.all` ã¯è¤‡æ•°ã®éåŒæœŸå‡¦ç†ã‚’åŒæ™‚ã«ã‚¹ã‚¿ãƒ¼ãƒˆã—ã¦ï¼Œå…¨ã¦ãŒå®Œäº†ã—ãŸãã®çµæœã‚’æ‰±ã„ãŸã„ã¨ãã«ä½¿ã„ã¾ã™ã€‚

```js
const p1 = new Promise((resolve, reject) => {
  setTimeout(() => resolve("æˆåŠŸğŸ˜„"), 100);
});

const p2 = new Promise((resolve, reject) => {
  setTimeout(() => resolve("æˆåŠŸğŸ˜"), 200);
});

const p3 = new Promise((resolve, reject) => {
  setTimeout(() => resolve("æˆåŠŸğŸ˜"), 300);
});

Promise.all([p1, p2, p3])
  .then(result => console.log(result)) // ["æˆåŠŸğŸ˜„", "æˆåŠŸğŸ˜", "æˆåŠŸğŸ˜"]
  .catch(e => console.log(e.message));
```

## `Promise.allSettled` ã¨ `Promise.any`

`Promise.all` ã¯ï¼ŒPromise ãŒ 1 ã¤ã§ã‚‚å¤±æ•—ã—ã¦ `rejected` ã«ãªã£ãŸã‚‰ï¼Œãã®çµæœã¯ `rejected` ã«ãªã£ã¦ã—ã¾ã„ã¾ã™ã€‚

```js
const p1 = new Promise((resolve, reject) => {
  setTimeout(() => resolve("æˆåŠŸğŸ˜„"), 100);
});

const p2 = new Promise((resolve, reject) => {
  setTimeout(() => resolve("æˆåŠŸğŸ˜"), 200);
});

const p3 = new Promise((resolve, reject) => {
  setTimeout(() => reject(new Error("å¤±æ•—ğŸ˜­")), 300);
});

Promise.all([p1, p2, p3])
  .then(result => console.log(result))
  .catch(e => console.log(e.message)); // "å¤±æ•—ğŸ˜­"
```

ãã“ã§æ–°ãŸã« 2 ã¤ã® API ãŒææ¡ˆã•ã‚Œï¼Œå°å…¥ã•ã‚Œã‚ˆã†ã¨ã—ã¦ã„ã¾ã™ã€‚

- `Promise.allSettled`ï¼šå…¨ã¦ã® Promise ãŒ Settled ã¨ãªã£ãŸçµæœ
- `Promise.any`ï¼šã„ãšã‚Œã‹ã® Promise ãŒæœ€åˆã« fulfilled ã¨ãªã£ãŸçµæœã€‚å…¨ã¦ã® Promise ãŒ rejected ã®å ´åˆã«ã®ã¿ï¼Œrejected çŠ¶æ…‹ã«ãªã‚‹ã€‚

å…ˆã»ã©ã®ä¾‹ã‚’ `Promise.allSettled` ã‚’ä½¿ã£ã¦æ›¸ãã¨ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

```js
const p1 = new Promise((resolve, reject) => {
  setTimeout(() => resolve("æˆåŠŸğŸ˜„"), 100);
});

const p2 = new Promise((resolve, reject) => {
  setTimeout(() => resolve("æˆåŠŸğŸ˜"), 200);
});

const p3 = new Promise((resolve, reject) => {
  setTimeout(() => reject(new Error("å¤±æ•—ğŸ˜­")), 300);
});

Promise.allSettled([p1, p2, p3])
  .then(result => console.log(result.map(r => r.value))) // ["æˆåŠŸğŸ˜„", "æˆåŠŸğŸ˜", undefined]
  .catch(e => console.log(e.message));
```

## `async` / `await`

ES2017 ã§è¿½åŠ ã•ã‚ŒãŸ Async é–¢æ•°ã‚’ä½¿ã†ã¨ï¼ŒPromise ã‚’æ›´ã«æ‰±ã„ã‚„ã™ããªã‚Šã¾ã™ã€‚Async é–¢æ•°ã¯ä»¥ä¸‹ã®ã‚ˆã†ã« `async` ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒã¤ã„ãŸé–¢æ•°ã§ã™ã€‚

```js
async function makePizza() {
  const ingredients = await prepareIngredients(); // ææ–™ã‚’ç”¨æ„ã—ã¾ã™
  const pizza = await bakePizza(); // ãƒ”ã‚¶ã‚’ç„¼ãã¾ã™
  return pizza;
}
```

Async é–¢æ•°ã®ä¸­ã§ã¯ï¼Œ`await` ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ã‚’ä½¿ç”¨ã§ãã¾ã™ã€‚ `await` ã¯ Promise ãŒ Settled ã«ãªã‚‹ã¾ã§å¾…æ©Ÿã—ï¼ŒçµæœãŒå¾—ã‚‰ã‚ŒãŸã‚‰å‡¦ç†ã‚’å†é–‹ã—ã¾ã™ã€‚ã‚‚ã—ã‚‚ãã® Promise ãŒ fulfilled ã¨ãªã£ãŸå ´åˆï¼Œ`await` ã¯ãã®å€¤ã‚’è¿”ã—ã¾ã™ã€‚ã‚‚ã—ã‚‚ rejected ã¨ãªã£ãŸå ´åˆã¯ãã®ã‚¨ãƒ©ãƒ¼ã‚’ throw ã—ã¾ã™ï¼ˆtry-catch æ§‹æ–‡ã§ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã§ãã¾ã™ï¼‰ã€‚

Async é–¢æ•°ã®çµæœã¯å¸¸ã« Promise ã§ã™ã€‚ã—ãŸãŒã£ã¦ä»¥ä¸‹ã® 2 ã¤ã® Async é–¢æ•°ã¯åŒã˜å€¤ï¼ˆ"ğŸ•"ã® Promiseï¼‰ã‚’è¿”ã—ã¾ã™ã€‚

```js
async function makePizza1() {
  return "ğŸ•";
}

async function makePizza2() {
  return Promise.resolve("ğŸ•");
}

const pizza1 = await makePizza1();
const pizza2 = await makePizza2();
console.log(pizza1 === pizza2); // true
```

`await` ã¯ Promise ã§ã¯ãªã„å€¤ã‚‚å—ã‘ä»˜ã‘ã¾ã™ã€‚

```js
const burger1 = await "ğŸ”";
const burger2 = await Promise.resolve("ğŸ”");
console.log(burger1 === burger2); // true
```

### ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯é–¢æ•°ã¨ `await`

ã¾ãšæœ€åˆã«ä»¥ä¸‹ã®ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ã‚’å®šç¾©ã—ã¾ã™ã€‚

```js
async function delayEcho(x, ms) {
  return new Promise(resolve =>
    setTimeout(() => {
      resolve(x);
    }, ms)
  );
}
```

å¼•æ•° `x` ã§æŒ‡å®šã—ãŸå€¤ã‚’å¼•æ•°`ms` ã§æŒ‡å®šã—ãŸåˆ†ã ã‘å¾…ã£ã¦ resolve ã™ã‚‹ Async é–¢æ•°ã§ã™ã€‚

`["ğŸ”", "ğŸ•", "ğŸ£"]`ã¨ã„ã†é…åˆ—ã‚’ã“ã®é–¢æ•°ã¨`.map()` ã§å‡¦ç†ã—ãŸã„ã¨ãï¼Œä»¥ä¸‹ã®ã‚ˆã†ã«æ›¸ããŸããªã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ãŒï¼Œ`.map()` ã«æ¸¡ã—ã¦ã„ã‚‹é–¢æ•°ã« `async` ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒç„¡ã„ãŸã‚ã‚·ãƒ³ã‚¿ãƒƒã‚¯ã‚¹ã‚¨ãƒ©ãƒ¼ã§ã™ã€‚

```js
async function delayedFoods() {
  const foods = ["ğŸ”", "ğŸ•", "ğŸ£"];
  return foods.map(f => await delayEcho(f, 100)); // ã‚·ãƒ³ã‚¿ãƒƒã‚¯ã‚¹ã‚¨ãƒ©ãƒ¼ ğŸ™…â€â™€ï¸
}

const x = await delayedFoods();
console.log(x);
```

ã‚³ãƒ¼ãƒ‰ãƒãƒƒã‚¯é–¢æ•°ã«ã‚‚ `async` ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’ã¤ã‘ã‚‹ã¨ã‚·ãƒ³ã‚¿ãƒƒã‚¯ã‚¹ã‚¨ãƒ©ãƒ¼ã¯ç„¡ããªã‚Šã¾ã™ãŒï¼Œå…ˆã«è¿°ã¹ãŸã¨ãŠã‚Š Async é–¢æ•°ã®è¿”ã‚Šå€¤ã¯ Promise ãªã®ã§ï¼Œæ­£ã—ãå‹•ä½œã™ã‚‹ã«ã¯ï¼Œ`Promise.all` ã‚’ä½¿ã£ã¦ä»¥ä¸‹ã®ã‚ˆã†ã«æ›¸ãã¾ã™ã€‚

```js
async function delayedFoods() {
  const foods = ["ğŸ”", "ğŸ•", "ğŸ£"];
  return Promise.all(foods.map(async f => await delayEcho(f, 100)));
}

const x = await delayedFoods();
console.log(x); // ["ğŸ”", "ğŸ•", "ğŸ£"]
```

å®Ÿã¯ã“ã®ä¾‹ã¯ï¼Œ `delayEcho` ã®çµæœã‚’ `await` ã™ã‚‹å¿…è¦ã¯ãªãä»¥ä¸‹ã®ã‚ˆã†ã«æ›¸ãã¨ã‚ˆã‚Šã‚·ãƒ³ãƒ—ãƒ«ã§ã™ã€‚

```js
async function delayedFoods() {
  const foods = ["ğŸ”", "ğŸ•", "ğŸ£"];
  return Promise.all(foods.map(f => delayEcho(f, 100)));
}
```

## Async ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³

æœ€å¾Œã«ï¼ŒES2018 ã§è¿½åŠ ã•ã‚ŒãŸ Async ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ã¿ã¦ã„ãã¾ã™ã€‚

```js
async function* collectFoods() {
  await new Promise(resolve => setTimeout(() => resolve(), 1000));
  yield delayEcho("ğŸŒ­", 100);
  yield delayEcho("ğŸœ", 100);
  yield "ğŸ–";
}
```

`collectFoods` ã¯ Async ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿é–¢æ•°ã§ã™ã€‚`await` ã«åŠ ãˆã¦ `yield` ã‚’ä½¿ã†ã“ã¨ãŒã§ãã¾ã™ã€‚`collectFoods`ã¯ Async iterator ã‚’ä½œæˆã—ã¾ã™ã€‚Async iterator ã¯ `.next()` ã‚’å‘¼ã³å‡ºã™ã¨çµæœãŒ Promise ã§è¿”ã£ã¦ãã¾ã™ã€‚

```js
const asyncIter = collectFoods();
console.log(await asyncIter.next()); // {value: "ğŸŒ­", done: false}
console.log(await asyncIter.next()); // {value: "ğŸœ", done: false}
console.log(await asyncIter.next()); // {value: "ğŸ–", done: false}
console.log(await asyncIter.next()); // {value: undefined, done: true}
```

ã•ã‚‰ã«ï¼ŒAsync Iterator ã®ãƒ«ãƒ¼ãƒ—ã¯ `for await...of` æ§‹æ–‡ã‚’ä½¿ã†ã“ã¨ãŒã§ãã¾ã™ã€‚

```js
for await (const food of collectFoods()) {
  console.log(food);
  // "ğŸŒ­"
  // "ğŸœ"
  // "ğŸ–"
}
```

ã¡ãªã¿ã« `for await...of` æ§‹æ–‡ã¯ Async ã§ã¯ç„¡ã„é€šå¸¸ã® iterator ã§ã‚‚æ­£å¸¸ã«å‹•ä½œã—ã¾ã™ã€‚

```js
for await (const food of ['ğŸ', 'ğŸŠ', Promise.resolve('ğŸ‹')]) {
  console.log(food);
  // ğŸ
  // ğŸŠ
  // ğŸ‹
}
```

## ãŠã‚ã‚Šã«

ä»Šå¹´ã¯ï¼Œåƒ­è¶ŠãªãŒã‚‰å‘¨å›²ã®äººã« JavaScript ã‚’æ•™ãˆã‚‹æ©Ÿä¼šã‚’ã„ãŸã ãã“ã¨ãŒå¤šã„ 1 å¹´ã§ã—ãŸã€‚ç‰¹ã« Promise ã«ã¤ã„ã¦è³ªå•ã•ã‚Œã‚‹ã“ã¨ãŒå¤šã‹ã£ãŸã®ã§ï¼Œã“ã®è¨˜äº‹ã‚’æ›¸ã“ã†ã¨æ€ã„ã¤ãã¾ã—ãŸã€‚æ¥å¹´ã‚‚å…ƒæ°—ã«ã‚„ã£ã¦ã„ãã¾ã™ã®ã§ã‚ˆã‚ã—ããŠé¡˜ã„ã—ã¾ã™ ğŸ‘‹

## å‚è€ƒ

- [Exploring ES2018 and ES2019](https://exploringjs.com/es2018-es2019/)
- [Promise.allSettled() - JavaScript | MDN](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise/allSettled)
- [Promise.any() - JavaScript | MDN](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise/any)
- [for await...of - JavaScript | MDN](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/for-await...of)
- [tc39/proposal-promise-any: ECMAScript proposal: Promise.any](https://github.com/tc39/proposal-promise-any)
- [tc39/proposal-async-iteration: Asynchronous iteration for JavaScript](https://github.com/tc39/proposal-async-iteration)
- [Promise combinators Â· V8](https://v8.dev/features/promise-combinators)
