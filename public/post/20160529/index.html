<!DOCTYPE html>
<html lang="en-us">
<head prefix="og: http://ogp.me/ns#">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1" />
  <meta property="og:title" content=" RxJavaのconcatMapEager &middot;  chooblarin&#39;s blog" />
  
  <meta name="theme-color" content="#8B3381" />
 
  <meta property="og:site_name" content="chooblarin&#39;s blog" />
  <meta property="og:url" content="http://chooblarin.github.io/post/20160529/" />
  
  
  <meta property="og:type" content="article" />
  
  <meta property="og:article:author" content="https://facebook.com/sou.hatake" />
  
  <meta property="og:article:published_time" content="2016-05-29T22:18:00&#43;09:00" />
  
  <meta property="og:article:tag" content="Java" />
  
  <meta property="og:article:tag" content="RxJava" />
  
  <meta property="og:article:tag" content="Android" />
  
  

  <title>
     RxJavaのconcatMapEager &middot;  chooblarin&#39;s blog
  </title>

  <link rel="stylesheet" href="http://chooblarin.github.io/css/bootstrap.min.css" />
  <link rel="stylesheet" href="http://chooblarin.github.io/css/main.css" />
  <link rel="stylesheet" href="http://chooblarin.github.io/css/font-awesome.min.css" />
  <link rel="stylesheet" href="http://chooblarin.github.io/css/font-noto-sans.css" />
  <link rel="stylesheet" href="http://chooblarin.github.io/css/github.css" />
  <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Source+Sans+Pro:200,300,400" type="text/css">
  <link rel="shortcut icon" href="http://chooblarin.github.io/images/favicon.ico" />
  <link rel="apple-touch-icon" href="http://chooblarin.github.io/images/apple-touch-icon.png" />
  
</head>
<body>
    <header class="global-header"  style="background-image:url( /images/bg.jpg )">
    <section class="header-text">
      <h1><a href="http://chooblarin.github.io/">chooblarin&#39;s blog</a></h1>
      
      <div class="tag-line">
        I am an engineer.
      </div>
      
      <div class="sns-links hidden-print">
  
  <a href="mailto:choo.bla.rin@gmail.com">
    <i class="fa fa-envelope"></i>
  </a>
  
  
  <a href="https://twitter.com/chooblarin" target="_blank">
    <i class="fa fa-twitter"></i>
  </a>
  
  
  <a href="https://instagram.com/sou_hatake" target="_blank">
    <i class="fa fa-instagram"></i>
  </a>
  
  
  
  <a href="https://facebook.com/sou.hatake" target="_blank">
    <i class="fa fa-facebook"></i>
  </a>
  
  
  <a href="https://github.com/chooblarin" target="_blank">
    <i class="fa fa-github"></i>
  </a>
  
  
  
  <a href="https://linkedin.com/in/sota-hatakeyama-35bb07120" target="_blank">
    <i class="fa fa-linkedin"></i>
  </a>
  
  
</div>

      
      <a href="http://chooblarin.github.io/" class="btn-header btn-back hidden-xs">
        <i class="fa fa-angle-left" aria-hidden="true"></i>
        &nbsp;Home
      </a>
      
      
    </section>
  </header>
  <main class="container">


<article>
  <header>
    <h1 class="text-primary">RxJavaのconcatMapEager</h1>
    <div class="post-meta clearfix">
      <div class="post-date pull-left">
        Posted on
        <time datetime="2016-05-29T22:18:00&#43;09:00">
          May 29, 2016
        </time>
      </div>
      <div class="pull-right">
        
        <span class="post-tag small"><a href="http://chooblarin.github.io//tags/java">#Java</a></span>
        
        <span class="post-tag small"><a href="http://chooblarin.github.io//tags/rxjava">#RxJava</a></span>
        
        <span class="post-tag small"><a href="http://chooblarin.github.io//tags/android">#Android</a></span>
        
      </div>
    </div>
  </header>
  <section>
    

<p>少し前の出来事なので忘れかけています．完全に忘れる前にブログに残しておきます．</p>

<h2 id="problem">Problem</h2>

<p>あるとき，Androidアプリの開発でこんなコードを書いていました．</p>

<ul>
<li><code>Item</code>というModelがある．</li>
<li><code>Item</code>はID文字列<code>id</code>をプロパティとしてもっている．</li>
<li><code>Item</code>のランキングデータを取得するWeb APIが用意されていて<code>Item</code>の<code>id</code>の一覧が取得出来る．</li>
<li>但し，取得出来るのは<code>id</code>のみなのでViewに表示するデータ(Itemの詳細)は別のAPIで取得する必要がある．</li>
</ul>

<h2 id="flatmap">flatMap()</h2>

<p>最初，私は<code>Observable#flatMap()</code>を使って以下のようにしました．</p>

<pre><code class="language-java">requestRankingItems()
    .flatMap(itemId -&gt; requestItem(itemId))
    .subscribe(item -&gt; { /* bind item to view */ })
</code></pre>

<p>しかしこのコードには問題があります．私はランキング情報をViewに表示させたかったに，これではランキングの順番がバラバラになってしまいます．
<a href="http://reactivex.io/documentation/operators/flatmap.html">flatMap</a>というオペレータは，
順番を保存しないからです．
上の例では<code>requestItem(itemId)</code>でサーバにリクエストして，レスポンスが返ってきた順番に値がemitされます．
<a href="http://fernandocejas.com/2015/01/11/rxjava-observable-tranformation-concatmap-vs-flatmap/">こちらの記事</a>がとても参考になります．</p>

<h2 id="concatmap">concatMap()</h2>

<p><code>Observable#concatMap()</code>は<code>Observable#flatMap()</code>と違って順番を保存してくれます．
そこで，コードをこのように変更してみました．</p>

<pre><code class="language-java">requestRankingItems()
    .concatMap(itemId -&gt; requestItem(itemId))
    .subscribe(item -&gt; { /* bind item to view */ })
</code></pre>

<p>ところが，ここで別の問題があります．<code>concatMap()</code>は，ソースObservableの値を1つずつ処理します．
現在の値の処理が完了するまで次の処理を行わないのです．つまり，上の例の場合，<code>requestItem(itemId)</code>でサーバにリクエストは，レスポンスが返ってくるまで次のリクエストを行わないのです．
これでは，1リクエスト1秒掛かるとすると，20件のItemを取得するのに20秒も待たなければなりません．</p>

<p>リクエストは並列で実行して，結果は順番通りに取得したいんですよ．
Javascriptの<code>Promise.all()</code>のように．
<a href="http://stackoverflow.com/questions/35339190/is-there-a-way-like-promise-all-in-rxjava">StackOverflow</a>でも質問をしてみましたが期待した答えはもらえませんでした．</p>

<h2 id="concatmapeager">concatMapEager()</h2>

<p>RxJavaのObservableに<code>concatMapEager</code>というオペレーターがあります．
<a href="http://reactivex.io/RxJava/javadoc/rx/Observable.html#concatMapEager(rx.functions.Func1)">ドキュメント</a>にはこう記されています．
&gt; Maps a sequence of values into Observables and concatenates these Observables eagerly into a single Observable.</p>

<p>どうやらeagerlyにconcatしてくれるらしいです．
更に</p>

<blockquote>
<p>Eager concatenation means that once a subscriber subscribes, this operator subscribes to all of the source Observables. The operator buffers the values emitted by these Observables and then drains them in order, each one after the previous one completes.</p>
</blockquote>

<p>concatMapEagerではソースObservable（上の例ではitemIdのObservable）をすべてsubscribeしてくれます．
つまり，すべてのidに対して一気にリクエストしてくれます．しかも結果はバッファリングされて，順番通りにemitされます．</p>

<pre><code class="language-java">requestRankingItems()
    .concatMapEager(itemId -&gt; requestItem(itemId))
    .subscribe(item -&gt; { /* bind item to view */ })
</code></pre>

<p>これでOKです．ただし<code>concatMapEager</code>はExperimentalですので今後も注目です．</p>

<h2 id="余談">余談</h2>

<p>「ブログに書く」という行為をすっかり忘れて暮らしていました．アウトプットはきちんと習慣化したいものですね．</p>

<h2 id="reference">Reference</h2>

<ul>
<li><a href="http://reactivex.io/RxJava/javadoc/rx/Observable.html#flatMap(rx.functions.Func1)">flatMap</a></li>
<li><a href="http://reactivex.io/RxJava/javadoc/rx/Observable.html#concatMap(rx.functions.Func1)">concatMap</a></li>
<li><a href="http://reactivex.io/RxJava/javadoc/rx/Observable.html#concatMapEager(rx.functions.Func1)">concatMapEager</a></li>
<li><a href="http://fernandocejas.com/2015/01/11/rxjava-observable-tranformation-concatmap-vs-flatmap/">RxJava Observable tranformation: concatMap() vs flatMap()</a></li>
<li><a href="https://github.com/ReactiveX/reactivex.github.io/issues/165">Document new concatEager() operator #165</a></li>
</ul>

  </section>
  <footer>
    
    <hr/>
    <div id="disqus_thread"></div>
    <script type="text/javascript">
      var disqus_shortname = 'chooblarin';
      (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    
    <section class="author-info row">
      <div class="author-avatar col-md-2">
        
        <img alt="Author Avatar" src="/images/kao.png" />
        
      </div>
      <div class="author-meta col-md-6">
        
        <h1 class="author-name text-primary">chooblarin</h1>
        
        
        <div class="author-bio">iOS/Android Application Developer</div>
        
      </div>
      
      <div class="author-contact col-md-4">
        <a href="mailto:choo.bla.rin@gmail.com">
          <i class="fa fa-envelope-o" aria-hidden="true"></i>
          &nbsp;Contact me
        </a>
      </div>
      
    </section>
    <ul class="pager">
      
      <li class="previous"><a href="http://chooblarin.github.io/post/20150828/"><span aria-hidden="true">&larr;</span> Older</a></li>
      
      
      <li class="next"><a href="http://chooblarin.github.io/post/natural-lang-with-swift/">Newer <span aria-hidden="true">&rarr;</span></a></li>
      
    </ul>
  </footer>
</article>

  </main>
  <footer class="container global-footer">
    <div class="copyright-note pull-left">
      &copy; 2016 chooblarin
    </div>
    <div class="sns-links hidden-print">
  
  <a href="mailto:choo.bla.rin@gmail.com">
    <i class="fa fa-envelope"></i>
  </a>
  
  
  <a href="https://twitter.com/chooblarin" target="_blank">
    <i class="fa fa-twitter"></i>
  </a>
  
  
  <a href="https://instagram.com/sou_hatake" target="_blank">
    <i class="fa fa-instagram"></i>
  </a>
  
  
  
  <a href="https://facebook.com/sou.hatake" target="_blank">
    <i class="fa fa-facebook"></i>
  </a>
  
  
  <a href="https://github.com/chooblarin" target="_blank">
    <i class="fa fa-github"></i>
  </a>
  
  
  
  <a href="https://linkedin.com/in/sota-hatakeyama-35bb07120" target="_blank">
    <i class="fa fa-linkedin"></i>
  </a>
  
  
</div>

  </footer>

  <script src="http://chooblarin.github.io/js/highlight.pack.js"></script>
  <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
  <script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [['$','$'], ['\\(','\\)']],
      displayMath: [['$$','$$'],
      processEscapes: true,
      processEnvironments: true,
      skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
      TeX: { equationNumbers: { autoNumber: "AMS" },
           extensions: ["AMSmath.js", "AMSsymbols.js"] }
    }
  });
  </script>
  <script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
      // Fix <code> tags after MathJax finishes running. This is a
      // hack to overcome a shortcoming of Markdown. Discussion at
      // https://github.com/mojombo/jekyll/issues/199
      var all = MathJax.Hub.getAllJax(), i;
      for(i = 0; i &lt; all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
      }
  });
  </script>
  <script>
    hljs.initHighlightingOnLoad();
  </script>
  
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-62520326-2', 'auto');
    ga('send', 'pageview');
  </script>
  
  
</body>
</html>

