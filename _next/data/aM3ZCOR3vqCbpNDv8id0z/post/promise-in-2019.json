{"pageProps":{"postContent":{"title":"2019年のPromise","date":"2019-12-01T00:00:00+00:00","slug":"promise-in-2019","tags":["JavaScript"],"draft":false,"content":"<p>この記事は<a href=\"https://adventar.org/calendars/4155\">フラー Advent Calendar 2019</a>の 1 日目の記事です。</p>\n<p>今年も JavaScript (TypeSctipt) をたくさん書きました。</p>\n<p>JavaScript には ECMAScript という標準仕様がありますが，近年では TC39 によって毎年新しい機能が追加されています。議論のプロセスは常にオープンになっているので誰でも閲覧できます <a href=\"https://github.com/tc39\">*</a>。</p>\n<p>そして今回は JavaScript の\"Promise\"にフォーカスして近況を解説します。</p>\n<h2>Promise で非同期プログラミング</h2>\n<p>Promise は ES2015 (ES6)で正式に導入されましたが，それ以前にも JavaScript プログラミングの非同期処理の中心にいました。</p>\n<p>まずは Promise について簡単に復習しましょう。コンストラクタで Promise を生成する一般的な形式の例を以下に示します。</p>\n<pre><code class=\"hljs language-js\"><span class=\"hljs-keyword\">const</span> promise = <span class=\"hljs-keyword\">new</span> <span class=\"hljs-title hljs-class\">Promise</span>(<span class=\"hljs-function\">(<span class=\"hljs-params\">resolve, reject</span>) =></span> {\n  <span class=\"hljs-title hljs-function\">doSomething</span>(<span class=\"hljs-function\"><span class=\"hljs-params\">x</span> =></span> {\n    <span class=\"hljs-keyword\">if</span> (x) {\n      <span class=\"hljs-comment\">// 成功</span>\n      <span class=\"hljs-title hljs-function\">resolve</span>(x);\n    } <span class=\"hljs-keyword\">else</span> {\n      <span class=\"hljs-title hljs-function\">reject</span>(<span class=\"hljs-keyword\">new</span> <span class=\"hljs-title hljs-class\">Error</span>(<span class=\"hljs-string\">\"失敗😢\"</span>));\n    }\n  });\n});\n\n\npromise\n  .<span class=\"hljs-title hljs-function\">then</span>(<span class=\"hljs-function\"><span class=\"hljs-params\">result</span> =></span> { ... })\n  .<span class=\"hljs-title hljs-function\">catch</span>(<span class=\"hljs-function\"><span class=\"hljs-params\">error</span> =></span> { ... });\n</code></pre>\n<p><code>doSomething</code> は何らかの非同期処理を行い，コールバックによって結果を得る関数です。無事に結果が得られたときは <code>resolve()</code> を使います。もしも結果が得られなかったときは <code>reject()</code>を使います。</p>\n<p>Promise には\"pending\", \"fulfilled\", \"rejected\" の 3 つの状態が存在します。先ほどの例で，<code>resolve()</code> か <code>reject()</code> を呼びだす前の状態は <strong>pending</strong> 状態です。呼び出したあとは <strong>fulfilled</strong> か <strong>rejected</strong> のいずれかの状態になります（これを <strong>Settled</strong> と呼びます）。</p>\n<img src=\"https://user-images.githubusercontent.com/3143302/69895358-261eb400-1371-11ea-9a11-7c88b1a6226d.png\" alt=\"promise has 3 states\" style=\"display:block;margin:0 auto;width:95%;max-width:320px;\">\n<p>Promise は必ず 3 つのうちいずれか状態をとりますが，Settled にならない場合もあります。例えば，以下の Promise は永久に pending 状態です。</p>\n<pre><code class=\"hljs language-js\"><span class=\"hljs-keyword\">const</span> p = <span class=\"hljs-keyword\">new</span> <span class=\"hljs-title hljs-class\">Promise</span>(<span class=\"hljs-function\">() =></span> {});\n</code></pre>\n<h2><code>.finally()</code></h2>\n<p>ES2018 では <code>Promise.prototype.finally()</code> が導入されています。</p>\n<pre><code class=\"hljs language-js\">promise\n  .<span class=\"hljs-title hljs-function\">then</span>(<span class=\"hljs-function\"><span class=\"hljs-params\">result</span> =></span> { ... })\n  .<span class=\"hljs-title hljs-function\">catch</span>(<span class=\"hljs-function\"><span class=\"hljs-params\">error</span> =></span> { ... })\n  .<span class=\"hljs-title hljs-function\">finally</span>(<span class=\"hljs-function\">() =></span> {\n    <span class=\"hljs-comment\">// 後始末をここに書く</span>\n  });\n</code></pre>\n<p><code>.finally()</code>のコールバック関数は，fulfilled か rejected かに関わらず実行されます。</p>\n<h2>複数の Promise を操る <code>Promise.all</code> と <code>Promise.race</code></h2>\n<p>ES2015 では， 複数の Promise を操作する API <code>Promise.all</code> と <code>Promise.race</code> の 2 つが導入されました。</p>\n<ul>\n<li><code>Promise.all</code>：全ての Promise が fulfilled となった結果</li>\n<li><code>Promise.race</code>：いずれかの Promise のうち最初に Settled となった結果</li>\n</ul>\n<p><code>Promise.all</code> は複数の非同期処理を同時にスタートして，全てが完了したその結果を扱いたいときに使います。</p>\n<pre><code class=\"hljs language-js\"><span class=\"hljs-keyword\">const</span> p1 = <span class=\"hljs-keyword\">new</span> <span class=\"hljs-title hljs-class\">Promise</span>(<span class=\"hljs-function\">(<span class=\"hljs-params\">resolve, reject</span>) =></span> {\n  <span class=\"hljs-built_in\">setTimeout</span>(<span class=\"hljs-function\">() =></span> <span class=\"hljs-title hljs-function\">resolve</span>(<span class=\"hljs-string\">\"成功😄\"</span>), <span class=\"hljs-number\">100</span>);\n});\n\n<span class=\"hljs-keyword\">const</span> p2 = <span class=\"hljs-keyword\">new</span> <span class=\"hljs-title hljs-class\">Promise</span>(<span class=\"hljs-function\">(<span class=\"hljs-params\">resolve, reject</span>) =></span> {\n  <span class=\"hljs-built_in\">setTimeout</span>(<span class=\"hljs-function\">() =></span> <span class=\"hljs-title hljs-function\">resolve</span>(<span class=\"hljs-string\">\"成功😁\"</span>), <span class=\"hljs-number\">200</span>);\n});\n\n<span class=\"hljs-keyword\">const</span> p3 = <span class=\"hljs-keyword\">new</span> <span class=\"hljs-title hljs-class\">Promise</span>(<span class=\"hljs-function\">(<span class=\"hljs-params\">resolve, reject</span>) =></span> {\n  <span class=\"hljs-built_in\">setTimeout</span>(<span class=\"hljs-function\">() =></span> <span class=\"hljs-title hljs-function\">resolve</span>(<span class=\"hljs-string\">\"成功😎\"</span>), <span class=\"hljs-number\">300</span>);\n});\n\n<span class=\"hljs-title hljs-class\">Promise</span>.<span class=\"hljs-title hljs-function\">all</span>([p1, p2, p3])\n  .<span class=\"hljs-title hljs-function\">then</span>(<span class=\"hljs-function\"><span class=\"hljs-params\">result</span> =></span> <span class=\"hljs-variable hljs-language\">console</span>.<span class=\"hljs-title hljs-function\">log</span>(result)) <span class=\"hljs-comment\">// [\"成功😄\", \"成功😁\", \"成功😎\"]</span>\n  .<span class=\"hljs-title hljs-function\">catch</span>(<span class=\"hljs-function\"><span class=\"hljs-params\">e</span> =></span> <span class=\"hljs-variable hljs-language\">console</span>.<span class=\"hljs-title hljs-function\">log</span>(e.<span class=\"hljs-property\">message</span>));\n</code></pre>\n<h2><code>Promise.allSettled</code> と <code>Promise.any</code></h2>\n<p><code>Promise.all</code> は，Promise が 1 つでも失敗して <code>rejected</code> になったら，その結果は <code>rejected</code> になってしまいます。</p>\n<pre><code class=\"hljs language-js\"><span class=\"hljs-keyword\">const</span> p1 = <span class=\"hljs-keyword\">new</span> <span class=\"hljs-title hljs-class\">Promise</span>(<span class=\"hljs-function\">(<span class=\"hljs-params\">resolve, reject</span>) =></span> {\n  <span class=\"hljs-built_in\">setTimeout</span>(<span class=\"hljs-function\">() =></span> <span class=\"hljs-title hljs-function\">resolve</span>(<span class=\"hljs-string\">\"成功😄\"</span>), <span class=\"hljs-number\">100</span>);\n});\n\n<span class=\"hljs-keyword\">const</span> p2 = <span class=\"hljs-keyword\">new</span> <span class=\"hljs-title hljs-class\">Promise</span>(<span class=\"hljs-function\">(<span class=\"hljs-params\">resolve, reject</span>) =></span> {\n  <span class=\"hljs-built_in\">setTimeout</span>(<span class=\"hljs-function\">() =></span> <span class=\"hljs-title hljs-function\">resolve</span>(<span class=\"hljs-string\">\"成功😁\"</span>), <span class=\"hljs-number\">200</span>);\n});\n\n<span class=\"hljs-keyword\">const</span> p3 = <span class=\"hljs-keyword\">new</span> <span class=\"hljs-title hljs-class\">Promise</span>(<span class=\"hljs-function\">(<span class=\"hljs-params\">resolve, reject</span>) =></span> {\n  <span class=\"hljs-built_in\">setTimeout</span>(<span class=\"hljs-function\">() =></span> <span class=\"hljs-title hljs-function\">reject</span>(<span class=\"hljs-keyword\">new</span> <span class=\"hljs-title hljs-class\">Error</span>(<span class=\"hljs-string\">\"失敗😭\"</span>)), <span class=\"hljs-number\">300</span>);\n});\n\n<span class=\"hljs-title hljs-class\">Promise</span>.<span class=\"hljs-title hljs-function\">all</span>([p1, p2, p3])\n  .<span class=\"hljs-title hljs-function\">then</span>(<span class=\"hljs-function\"><span class=\"hljs-params\">result</span> =></span> <span class=\"hljs-variable hljs-language\">console</span>.<span class=\"hljs-title hljs-function\">log</span>(result))\n  .<span class=\"hljs-title hljs-function\">catch</span>(<span class=\"hljs-function\"><span class=\"hljs-params\">e</span> =></span> <span class=\"hljs-variable hljs-language\">console</span>.<span class=\"hljs-title hljs-function\">log</span>(e.<span class=\"hljs-property\">message</span>)); <span class=\"hljs-comment\">// \"失敗😭\"</span>\n</code></pre>\n<p>そこで新たに 2 つの API が提案され，導入されようとしています。</p>\n<ul>\n<li><code>Promise.allSettled</code>：全ての Promise が Settled となった結果</li>\n<li><code>Promise.any</code>：いずれかの Promise が最初に fulfilled となった結果。全ての Promise が rejected の場合にのみ，rejected 状態になる。</li>\n</ul>\n<p>先ほどの例を <code>Promise.allSettled</code> を使って書くと以下のようになります。</p>\n<pre><code class=\"hljs language-js\"><span class=\"hljs-keyword\">const</span> p1 = <span class=\"hljs-keyword\">new</span> <span class=\"hljs-title hljs-class\">Promise</span>(<span class=\"hljs-function\">(<span class=\"hljs-params\">resolve, reject</span>) =></span> {\n  <span class=\"hljs-built_in\">setTimeout</span>(<span class=\"hljs-function\">() =></span> <span class=\"hljs-title hljs-function\">resolve</span>(<span class=\"hljs-string\">\"成功😄\"</span>), <span class=\"hljs-number\">100</span>);\n});\n\n<span class=\"hljs-keyword\">const</span> p2 = <span class=\"hljs-keyword\">new</span> <span class=\"hljs-title hljs-class\">Promise</span>(<span class=\"hljs-function\">(<span class=\"hljs-params\">resolve, reject</span>) =></span> {\n  <span class=\"hljs-built_in\">setTimeout</span>(<span class=\"hljs-function\">() =></span> <span class=\"hljs-title hljs-function\">resolve</span>(<span class=\"hljs-string\">\"成功😁\"</span>), <span class=\"hljs-number\">200</span>);\n});\n\n<span class=\"hljs-keyword\">const</span> p3 = <span class=\"hljs-keyword\">new</span> <span class=\"hljs-title hljs-class\">Promise</span>(<span class=\"hljs-function\">(<span class=\"hljs-params\">resolve, reject</span>) =></span> {\n  <span class=\"hljs-built_in\">setTimeout</span>(<span class=\"hljs-function\">() =></span> <span class=\"hljs-title hljs-function\">reject</span>(<span class=\"hljs-keyword\">new</span> <span class=\"hljs-title hljs-class\">Error</span>(<span class=\"hljs-string\">\"失敗😭\"</span>)), <span class=\"hljs-number\">300</span>);\n});\n\n<span class=\"hljs-title hljs-class\">Promise</span>.<span class=\"hljs-title hljs-function\">allSettled</span>([p1, p2, p3])\n  .<span class=\"hljs-title hljs-function\">then</span>(<span class=\"hljs-function\"><span class=\"hljs-params\">result</span> =></span> <span class=\"hljs-variable hljs-language\">console</span>.<span class=\"hljs-title hljs-function\">log</span>(result.<span class=\"hljs-title hljs-function\">map</span>(<span class=\"hljs-function\"><span class=\"hljs-params\">r</span> =></span> r.<span class=\"hljs-property\">value</span>))) <span class=\"hljs-comment\">// [\"成功😄\", \"成功😁\", undefined]</span>\n  .<span class=\"hljs-title hljs-function\">catch</span>(<span class=\"hljs-function\"><span class=\"hljs-params\">e</span> =></span> <span class=\"hljs-variable hljs-language\">console</span>.<span class=\"hljs-title hljs-function\">log</span>(e.<span class=\"hljs-property\">message</span>));\n</code></pre>\n<h2><code>async</code> / <code>await</code></h2>\n<p>ES2017 で追加された Async 関数を使うと，Promise を更に扱いやすくなります。Async 関数は以下のように <code>async</code> キーワードがついた関数です。</p>\n<pre><code class=\"hljs language-js\"><span class=\"hljs-keyword\">async</span> <span class=\"hljs-keyword\">function</span> <span class=\"hljs-title hljs-function\">makePizza</span>(<span class=\"hljs-params\"></span>) {\n  <span class=\"hljs-keyword\">const</span> ingredients = <span class=\"hljs-keyword\">await</span> <span class=\"hljs-title hljs-function\">prepareIngredients</span>(); <span class=\"hljs-comment\">// 材料を用意します</span>\n  <span class=\"hljs-keyword\">const</span> pizza = <span class=\"hljs-keyword\">await</span> <span class=\"hljs-title hljs-function\">bakePizza</span>(); <span class=\"hljs-comment\">// ピザを焼きます</span>\n  <span class=\"hljs-keyword\">return</span> pizza;\n}\n</code></pre>\n<p>Async 関数の中では，<code>await</code> オペレータを使用できます。 <code>await</code> は Promise が Settled になるまで待機し，結果が得られたら処理を再開します。もしもその Promise が fulfilled となった場合，<code>await</code> はその値を返します。もしも rejected となった場合はそのエラーを throw します（try-catch 構文でハンドリングできます）。</p>\n<p>Async 関数の結果は常に Promise です。したがって以下の 2 つの Async 関数は同じ値（\"🍕\"の Promise）を返します。</p>\n<pre><code class=\"hljs language-js\"><span class=\"hljs-keyword\">async</span> <span class=\"hljs-keyword\">function</span> <span class=\"hljs-title hljs-function\">makePizza1</span>(<span class=\"hljs-params\"></span>) {\n  <span class=\"hljs-keyword\">return</span> <span class=\"hljs-string\">\"🍕\"</span>;\n}\n\n<span class=\"hljs-keyword\">async</span> <span class=\"hljs-keyword\">function</span> <span class=\"hljs-title hljs-function\">makePizza2</span>(<span class=\"hljs-params\"></span>) {\n  <span class=\"hljs-keyword\">return</span> <span class=\"hljs-title hljs-class\">Promise</span>.<span class=\"hljs-title hljs-function\">resolve</span>(<span class=\"hljs-string\">\"🍕\"</span>);\n}\n\n<span class=\"hljs-keyword\">const</span> pizza1 = <span class=\"hljs-keyword\">await</span> <span class=\"hljs-title hljs-function\">makePizza1</span>();\n<span class=\"hljs-keyword\">const</span> pizza2 = <span class=\"hljs-keyword\">await</span> <span class=\"hljs-title hljs-function\">makePizza2</span>();\n<span class=\"hljs-variable hljs-language\">console</span>.<span class=\"hljs-title hljs-function\">log</span>(pizza1 === pizza2); <span class=\"hljs-comment\">// true</span>\n</code></pre>\n<p><code>await</code> は Promise ではない値も受け付けます。</p>\n<pre><code class=\"hljs language-js\"><span class=\"hljs-keyword\">const</span> burger1 = <span class=\"hljs-keyword\">await</span> <span class=\"hljs-string\">\"🍔\"</span>;\n<span class=\"hljs-keyword\">const</span> burger2 = <span class=\"hljs-keyword\">await</span> <span class=\"hljs-title hljs-class\">Promise</span>.<span class=\"hljs-title hljs-function\">resolve</span>(<span class=\"hljs-string\">\"🍔\"</span>);\n<span class=\"hljs-variable hljs-language\">console</span>.<span class=\"hljs-title hljs-function\">log</span>(burger1 === burger2); <span class=\"hljs-comment\">// true</span>\n</code></pre>\n<h3>コールバック関数と <code>await</code></h3>\n<p>まず最初に以下のヘルパー関数を定義します。</p>\n<pre><code class=\"hljs language-js\"><span class=\"hljs-keyword\">async</span> <span class=\"hljs-keyword\">function</span> <span class=\"hljs-title hljs-function\">delayEcho</span>(<span class=\"hljs-params\">x, ms</span>) {\n  <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">new</span> <span class=\"hljs-title hljs-class\">Promise</span>(<span class=\"hljs-function\"><span class=\"hljs-params\">resolve</span> =></span>\n    <span class=\"hljs-built_in\">setTimeout</span>(<span class=\"hljs-function\">() =></span> {\n      <span class=\"hljs-title hljs-function\">resolve</span>(x);\n    }, ms)\n  );\n}\n</code></pre>\n<p>引数 <code>x</code> で指定した値を引数<code>ms</code> で指定した分だけ待って resolve する Async 関数です。</p>\n<p><code>[\"🍔\", \"🍕\", \"🍣\"]</code>という配列をこの関数と<code>.map()</code> で処理したいとき，以下のように書きたくなるかもしれませんが，<code>.map()</code> に渡している関数に <code>async</code> キーワードが無いためシンタックスエラーです。</p>\n<pre><code class=\"hljs language-js\"><span class=\"hljs-keyword\">async</span> <span class=\"hljs-keyword\">function</span> <span class=\"hljs-title hljs-function\">delayedFoods</span>(<span class=\"hljs-params\"></span>) {\n  <span class=\"hljs-keyword\">const</span> foods = [<span class=\"hljs-string\">\"🍔\"</span>, <span class=\"hljs-string\">\"🍕\"</span>, <span class=\"hljs-string\">\"🍣\"</span>];\n  <span class=\"hljs-keyword\">return</span> foods.<span class=\"hljs-title hljs-function\">map</span>(<span class=\"hljs-function\"><span class=\"hljs-params\">f</span> =></span> <span class=\"hljs-keyword\">await</span> <span class=\"hljs-title hljs-function\">delayEcho</span>(f, <span class=\"hljs-number\">100</span>)); <span class=\"hljs-comment\">// シンタックスエラー 🙅‍♀️</span>\n}\n\n<span class=\"hljs-keyword\">const</span> x = <span class=\"hljs-keyword\">await</span> <span class=\"hljs-title hljs-function\">delayedFoods</span>();\n<span class=\"hljs-variable hljs-language\">console</span>.<span class=\"hljs-title hljs-function\">log</span>(x);\n</code></pre>\n<p>コードバック関数にも <code>async</code> キーワードをつけるとシンタックスエラーは無くなりますが，先に述べたとおり Async 関数の返り値は Promise なので，正しく動作するには，<code>Promise.all</code> を使って以下のように書きます。</p>\n<pre><code class=\"hljs language-js\"><span class=\"hljs-keyword\">async</span> <span class=\"hljs-keyword\">function</span> <span class=\"hljs-title hljs-function\">delayedFoods</span>(<span class=\"hljs-params\"></span>) {\n  <span class=\"hljs-keyword\">const</span> foods = [<span class=\"hljs-string\">\"🍔\"</span>, <span class=\"hljs-string\">\"🍕\"</span>, <span class=\"hljs-string\">\"🍣\"</span>];\n  <span class=\"hljs-keyword\">return</span> <span class=\"hljs-title hljs-class\">Promise</span>.<span class=\"hljs-title hljs-function\">all</span>(foods.<span class=\"hljs-title hljs-function\">map</span>(<span class=\"hljs-keyword\">async</span> f => <span class=\"hljs-keyword\">await</span> <span class=\"hljs-title hljs-function\">delayEcho</span>(f, <span class=\"hljs-number\">100</span>)));\n}\n\n<span class=\"hljs-keyword\">const</span> x = <span class=\"hljs-keyword\">await</span> <span class=\"hljs-title hljs-function\">delayedFoods</span>();\n<span class=\"hljs-variable hljs-language\">console</span>.<span class=\"hljs-title hljs-function\">log</span>(x); <span class=\"hljs-comment\">// [\"🍔\", \"🍕\", \"🍣\"]</span>\n</code></pre>\n<p>実はこの例は， <code>delayEcho</code> の結果を <code>await</code> する必要はなく以下のように書くとよりシンプルです。</p>\n<pre><code class=\"hljs language-js\"><span class=\"hljs-keyword\">async</span> <span class=\"hljs-keyword\">function</span> <span class=\"hljs-title hljs-function\">delayedFoods</span>(<span class=\"hljs-params\"></span>) {\n  <span class=\"hljs-keyword\">const</span> foods = [<span class=\"hljs-string\">\"🍔\"</span>, <span class=\"hljs-string\">\"🍕\"</span>, <span class=\"hljs-string\">\"🍣\"</span>];\n  <span class=\"hljs-keyword\">return</span> <span class=\"hljs-title hljs-class\">Promise</span>.<span class=\"hljs-title hljs-function\">all</span>(foods.<span class=\"hljs-title hljs-function\">map</span>(<span class=\"hljs-function\"><span class=\"hljs-params\">f</span> =></span> <span class=\"hljs-title hljs-function\">delayEcho</span>(f, <span class=\"hljs-number\">100</span>)));\n}\n</code></pre>\n<h2>Async イテレーション</h2>\n<p>最後に，ES2018 で追加された Async イテレーションをみていきます。</p>\n<pre><code class=\"hljs language-js\"><span class=\"hljs-keyword\">async</span> <span class=\"hljs-keyword\">function</span>* <span class=\"hljs-title hljs-function\">collectFoods</span>(<span class=\"hljs-params\"></span>) {\n  <span class=\"hljs-keyword\">await</span> <span class=\"hljs-keyword\">new</span> <span class=\"hljs-title hljs-class\">Promise</span>(<span class=\"hljs-function\"><span class=\"hljs-params\">resolve</span> =></span> <span class=\"hljs-built_in\">setTimeout</span>(<span class=\"hljs-function\">() =></span> <span class=\"hljs-title hljs-function\">resolve</span>(), <span class=\"hljs-number\">1000</span>));\n  <span class=\"hljs-keyword\">yield</span> <span class=\"hljs-title hljs-function\">delayEcho</span>(<span class=\"hljs-string\">\"🌭\"</span>, <span class=\"hljs-number\">100</span>);\n  <span class=\"hljs-keyword\">yield</span> <span class=\"hljs-title hljs-function\">delayEcho</span>(<span class=\"hljs-string\">\"🍜\"</span>, <span class=\"hljs-number\">100</span>);\n  <span class=\"hljs-keyword\">yield</span> <span class=\"hljs-string\">\"🍖\"</span>;\n}\n</code></pre>\n<p><code>collectFoods</code> は Async ジェネレータ関数です。<code>await</code> に加えて <code>yield</code> を使うことができます。<code>collectFoods</code>は Async iterator を作成します。Async iterator は <code>.next()</code> を呼び出すと結果が Promise で返ってきます。</p>\n<pre><code class=\"hljs language-js\"><span class=\"hljs-keyword\">const</span> asyncIter = <span class=\"hljs-title hljs-function\">collectFoods</span>();\n<span class=\"hljs-variable hljs-language\">console</span>.<span class=\"hljs-title hljs-function\">log</span>(<span class=\"hljs-keyword\">await</span> asyncIter.<span class=\"hljs-title hljs-function\">next</span>()); <span class=\"hljs-comment\">// {value: \"🌭\", done: false}</span>\n<span class=\"hljs-variable hljs-language\">console</span>.<span class=\"hljs-title hljs-function\">log</span>(<span class=\"hljs-keyword\">await</span> asyncIter.<span class=\"hljs-title hljs-function\">next</span>()); <span class=\"hljs-comment\">// {value: \"🍜\", done: false}</span>\n<span class=\"hljs-variable hljs-language\">console</span>.<span class=\"hljs-title hljs-function\">log</span>(<span class=\"hljs-keyword\">await</span> asyncIter.<span class=\"hljs-title hljs-function\">next</span>()); <span class=\"hljs-comment\">// {value: \"🍖\", done: false}</span>\n<span class=\"hljs-variable hljs-language\">console</span>.<span class=\"hljs-title hljs-function\">log</span>(<span class=\"hljs-keyword\">await</span> asyncIter.<span class=\"hljs-title hljs-function\">next</span>()); <span class=\"hljs-comment\">// {value: undefined, done: true}</span>\n</code></pre>\n<p>さらに，Async Iterator のループは <code>for await...of</code> 構文を使うことができます。</p>\n<pre><code class=\"hljs language-js\"><span class=\"hljs-keyword\">for</span> <span class=\"hljs-keyword\">await</span> (<span class=\"hljs-keyword\">const</span> food <span class=\"hljs-keyword\">of</span> <span class=\"hljs-title hljs-function\">collectFoods</span>()) {\n  <span class=\"hljs-variable hljs-language\">console</span>.<span class=\"hljs-title hljs-function\">log</span>(food);\n  <span class=\"hljs-comment\">// \"🌭\"</span>\n  <span class=\"hljs-comment\">// \"🍜\"</span>\n  <span class=\"hljs-comment\">// \"🍖\"</span>\n}\n</code></pre>\n<p>ちなみに <code>for await...of</code> 構文は Async では無い通常の iterator でも正常に動作します。</p>\n<pre><code class=\"hljs language-js\"><span class=\"hljs-keyword\">for</span> <span class=\"hljs-keyword\">await</span> (<span class=\"hljs-keyword\">const</span> food <span class=\"hljs-keyword\">of</span> [<span class=\"hljs-string\">'🍎'</span>, <span class=\"hljs-string\">'🍊'</span>, <span class=\"hljs-title hljs-class\">Promise</span>.<span class=\"hljs-title hljs-function\">resolve</span>(<span class=\"hljs-string\">'🍋'</span>)]) {\n  <span class=\"hljs-variable hljs-language\">console</span>.<span class=\"hljs-title hljs-function\">log</span>(food);\n  <span class=\"hljs-comment\">// 🍎</span>\n  <span class=\"hljs-comment\">// 🍊</span>\n  <span class=\"hljs-comment\">// 🍋</span>\n}\n</code></pre>\n<h2>おわりに</h2>\n<p>今年は，僭越ながら周囲の人に JavaScript を教える機会をいただくことが多い 1 年でした。特に Promise について質問されることが多かったので，この記事を書こうと思いつきました。来年も元気にやっていきますのでよろしくお願いします 👋</p>\n<h2>参考</h2>\n<ul>\n<li><a href=\"https://exploringjs.com/es2018-es2019/\">Exploring ES2018 and ES2019</a></li>\n<li><a href=\"https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise/allSettled\">Promise.allSettled() - JavaScript | MDN</a></li>\n<li><a href=\"https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise/any\">Promise.any() - JavaScript | MDN</a></li>\n<li><a href=\"https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/for-await...of\">for await...of - JavaScript | MDN</a></li>\n<li><a href=\"https://github.com/tc39/proposal-promise-any\">tc39/proposal-promise-any: ECMAScript proposal: Promise.any</a></li>\n<li><a href=\"https://github.com/tc39/proposal-async-iteration\">tc39/proposal-async-iteration: Asynchronous iteration for JavaScript</a></li>\n<li><a href=\"https://v8.dev/features/promise-combinators\">Promise combinators · V8</a></li>\n</ul>"}},"__N_SSG":true}