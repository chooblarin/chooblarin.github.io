{"pageProps":{"postContent":{"title":"Hello PhoenixをHerokuで","date":"2015-08-28T07:15:00+09:00","slug":"20150828","tags":["Elixir"],"draft":false,"content":"<p>つい先日弊社では Elixir の<a href=\"https://gist.github.com/chooblarin/2432345f7b11629bafd9\">社内勉強会</a>を行いました．</p>\n<p>今回は<a href=\"https://www.phoenixframework.org\">Phoenix</a>を Heroku で動かしてみます．</p>\n<p>以下のサイトを参考にさせてもらいました．</p>\n<ul>\n<li><a href=\"https://wsmoak.net/2015/07/05/phoenix-on-heroku.html\">Deploying a Phoenix app to Heroku</a></li>\n</ul>\n<h2>Phoenix をインストール</h2>\n<p><a href=\"https://www.phoenixframework.org/docs/installation\">公式サイト</a>に記載の通りです．</p>\n<p>Hex をインストール</p>\n<pre><code class=\"hljs language-sh\">$ mix local.hex</code></pre>\n<p>Phoenix アーカイブをインストール</p>\n<pre><code class=\"hljs language-sh\">$ mix archive.install https://github.com/phoenixframework/phoenix/releases/download/v0.17.1/phoenix_new-0.17.1.ez</code></pre>\n<h2>Hello Phoenix</h2>\n<p>これも<a href=\"https://www.phoenixframework.org/docs/up-and-running\">公式サイト</a>通り．</p>\n<p>Phoenix プロジェクトを作成</p>\n<pre><code class=\"hljs language-sh\">$ mix phoenix.new hello_phoenix</code></pre>\n<p>起動</p>\n<pre><code class=\"hljs language-sh\">$ <span class=\"hljs-built_in\">cd</span> hello_phoenix\n$ mix phoenix.server</code></pre>\n<p>確認 => <a href=\"http://localhost:4000\">http://localhost:4000</a></p>\n<h2>Heroku にデプロイ</h2>\n<p>Buildpack に<a href=\"https://github.com/HashNuke/heroku-buildpack-elixir\">Heroku Buildpack for Elixir</a>と<a href=\"https://github.com/gjaldon/heroku-buildpack-phoenix-static\">Phoenix Static Buildpack</a>の 2 つを使用します．</p>\n<h3>.gitignore ファイルを編集</h3>\n<p><code>.gitignore</code>の<code>config/prod.secret.exs</code>をコメントアウトします．</p>\n<pre><code class=\"hljs language-txt\">...\n\n# The config/prod.secret.exs file by default contains sensitive\n# data and you should not commit it into version control.\n#\n# Alternatively, you may comment the line below and commit the\n# secrets file as long as you replace its contents by environment\n# variables.\n#/config/prod.secret.exs</code></pre>\n<h3>Heroku の環境編集を設定</h3>\n<p><code>config/prod.secret.exs</code>を<code>.gitignore</code>の対象から外したので，重要な情報を heroku の環境変数に置き換えます．</p>\n<pre><code class=\"hljs language-elixir\"><span class=\"hljs-keyword\">use</span> Mix.Config\n\n<span class=\"hljs-comment\"># In this file, we keep production configuration that</span>\n<span class=\"hljs-comment\"># you likely want to automate and keep it away from</span>\n<span class=\"hljs-comment\"># your version control system.</span>\nconfig <span class=\"hljs-symbol\">:hello_phoenix_heroku</span>, HelloPhoenixHeroku.Endpoint,\n  <span class=\"hljs-symbol\">secret_key_base:</span> System.get_env(<span class=\"hljs-string\">\"SECRET_KEY_BASE\"</span>)\n\n<span class=\"hljs-comment\"># Configure your database</span>\nconfig <span class=\"hljs-symbol\">:hello_phoenix_heroku</span>, HelloPhoenixHeroku.Repo,\n  <span class=\"hljs-symbol\">adapter:</span> Ecto.Adapters.Postgres,\n  <span class=\"hljs-symbol\">username:</span> System.get_env(<span class=\"hljs-string\">\"DATABASE_USERNAME\"</span>),\n  <span class=\"hljs-symbol\">password:</span> System.get_env(<span class=\"hljs-string\">\"DATABASE_PASSWORD\"</span>),\n  <span class=\"hljs-symbol\">database:</span> <span class=\"hljs-string\">\"hello_phoenix_heroku_prod\"</span>,\n  <span class=\"hljs-symbol\">size:</span> <span class=\"hljs-number\">20</span> <span class=\"hljs-comment\"># The amount of database connections in the pool</span></code></pre>\n<pre><code class=\"hljs language-sh\">$ heroku config:<span class=\"hljs-built_in\">set</span> SECRET_KEY_BASE=&#x3C;YOUR_SECRET_KEY_BASE>\n$ heroku config:<span class=\"hljs-built_in\">set</span> SECRET_KEY_BASE=&#x3C;YOUR_DATABASE_USERNAME>\n$ heroku config:<span class=\"hljs-built_in\">set</span> SECRET_KEY_BASE=&#x3C;YOUR_DATABASE_PASSWORD></code></pre>\n<h3>必要な設定ファイルを作成</h3>\n<p><code>elixir_buildpack.config</code>ファイルと<code>Procfile</code>をプロジェクトのルートに作成します．</p>\n<ul>\n<li>elixir_buildpack.config</li>\n</ul>\n<pre><code class=\"hljs language-txt\"># Erlang version\nerlang_version=17.5\n\n# Elixir version\nelixir_version=1.0.4\n\n# Always rebuild from scratch on every deploy?\nalways_rebuild=false\n\n# Export heroku config vars\nconfig_vars_to_export=(DATABASE_URL SECRET_KEY_BASE)\n\n# A command to run right after compiling the app\npost_compile=\"pwd\"</code></pre>\n<ul>\n<li>Procfile</li>\n</ul>\n<pre><code class=\"hljs language-txt\">web: mix phoenix.server</code></pre>\n<p>そしたら git コミットします．</p>\n<pre><code class=\"hljs language-sh\">$ git init\n$ git add .\n$ git commit -m <span class=\"hljs-string\">\"Hello, Phoenix\"</span></code></pre>\n<h3>デプロイ</h3>\n<p>Heroku アプリを作成</p>\n<pre><code class=\"hljs language-sh\">$ heroku create --buildpack <span class=\"hljs-string\">\"https://github.com/HashNuke/heroku-buildpack-elixir.git\"</span></code></pre>\n<p>以下の 2 つの Buildpack を設定</p>\n<ul>\n<li><a href=\"https://github.com/HashNuke/heroku-buildpack-elixir\">Heroku Buildpack for Elixir</a></li>\n<li><a href=\"https://github.com/gjaldon/heroku-buildpack-phoenix-static\">Phoenix Static Buildpack</a></li>\n</ul>\n<pre><code class=\"hljs language-sh\">$ heroku buildpacks:<span class=\"hljs-built_in\">set</span> https://github.com/gjaldon/phoenix-static-buildpack\n$ heroku buildpacks:add --index 1 https://github.com/HashNuke/heroku-buildpack-elixir</code></pre>\n<p>ぷっしゅ</p>\n<pre><code class=\"hljs language-sh\">$ git push heroku master</code></pre>\n<p><a href=\"https://chooblaphoenix.herokuapp.com\">出来た！</a></p>\n"}},"__N_SSG":true}