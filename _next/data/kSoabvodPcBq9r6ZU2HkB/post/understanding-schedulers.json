{"pageProps":{"postContent":{"title":"RxSwiftã®Schedulersã¨æˆ¯ã‚Œã‚‹","date":"2017-05-05T13:36:25+09:00","slug":"understanding-schedulers","tags":["Swift","RxSwift"],"draft":false,"content":"<p>iOS ã®ã‚¢ãƒ—ãƒªé–‹ç™ºã‚’å§‹ã‚ã¦ 1 å¹´ãŒçµŒéã—ã¾ã—ãŸï¼RxSwift ã¨ã®ä»˜ãåˆã„ã‚‚ 1 å¹´ãŒçµŒéã—ã¾ã—ãŸï¼æœ€è¿‘ã¯ä»•äº‹ã§å†ã³ Android ã®æ‹…å½“ã«ãªã‚Šã¾ã—ãŸï¼</p>\n<p>ã“ã®è¨˜äº‹ã¯ RxSwift ã¨ Schedulers ã«ã¤ã„ã¦æ›¸ãã¾ã—ãŸï¼GCD ã®è©±ã¯å‡ºã¦æ¥ã¾ã›ã‚“ã®ã§çœŸå‰£ã«å‹‰å¼·ã—ãŸæ–¹ã«ã¯ä»¥ä¸‹ã®è§£èª¬ãŒã¨ã¦ã‚‚ç´ æ™´ã‚‰ã—ã„ã§ã™ï¼</p>\n<ul>\n<li><a href=\"https://github.com/mixi-inc/iOSTraining/wiki/8.2-Grand-Central-Dispatch\">8.2 Grand Central Dispatch Â· mixi-inc/iOSTraining Wiki</a></li>\n</ul>\n<hr>\n<h2>Observable ã¨ã‚¹ãƒ¬ãƒƒãƒ‰</h2>\n<p>Swift ã¯ 3.1 ã§ã™ï¼</p>\n<p>ã¾ãšï¼ŒRxSwift ã§ã¦ãã¨ã†ãª Observable ã‚’ä½œã‚Šã¾ã™ï¼</p>\n<pre><code class=\"hljs language-swift\"><span class=\"hljs-keyword\">let</span> observable <span class=\"hljs-operator\">=</span> <span class=\"hljs-type\">Observable</span>&#x3C;<span class=\"hljs-type\">String</span>>.create { observer -> <span class=\"hljs-type\">Disposable</span> <span class=\"hljs-keyword\">in</span>\n  observer.onNext(<span class=\"hljs-string\">\"YO!ğŸ˜\"</span>)\n  observer.onCompleted()\n}\n</code></pre>\n<pre><code class=\"hljs language-swift\">observable.subscribe(onNext: { (message: <span class=\"hljs-type\">String</span>) <span class=\"hljs-keyword\">in</span>\n  <span class=\"hljs-built_in\">print</span>(message)\n})\n</code></pre>\n<pre><code class=\"hljs language-txt\">YO!ğŸ˜\n</code></pre>\n<p>æ¬¡ã«ï¼Œ5 ç§’å¾Œã«ã€ŒYO!ã€ã‚’å—ã‘å–ã‚‹ã‚ˆã†ã« Observable ã‚’å¤‰æ›´ã—ã¾ã™ï¼</p>\n<pre><code class=\"hljs language-Swift\"><span class=\"hljs-keyword\">let</span> observable <span class=\"hljs-operator\">=</span> <span class=\"hljs-type\">Observable</span>&#x3C;<span class=\"hljs-type\">String</span>>.create { observer -> <span class=\"hljs-type\">Disposable</span> <span class=\"hljs-keyword\">in</span>\n  <span class=\"hljs-type\">Thread</span>.sleep(forTimeInterval: <span class=\"hljs-number\">5</span>) <span class=\"hljs-comment\">// Blocking</span>\n  observer.onNext(<span class=\"hljs-string\">\"YO!ğŸ˜\"</span>)\n  observer.onCompleted()\n  <span class=\"hljs-keyword\">return</span> <span class=\"hljs-type\">Disposables</span>.create()\n}\n</code></pre>\n<p>Observable ã®å‡¦ç†ã¯ï¼Œé€šå¸¸ã¯<code>subscribe</code>ã‚’å‘¼ã³å‡ºã—ãŸã‚¹ãƒ¬ãƒƒãƒ‰ã§å®Ÿè¡Œã•ã‚Œã¾ã™ï¼\nãªã®ã§<code>Thread.sleep</code>ã¯ main ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’ãƒ–ãƒ­ãƒƒã‚¯ã—ã¦ã„ã¾ã™ï¼main ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’ãƒ–ãƒ­ãƒƒã‚¯ã™ã‚‹ã®ã¯ã‚¤ã‚±ãªã„ã“ã¨ãªã®ã§ï¼Œæ˜ç¤ºçš„ã«åˆ¥ã®ã‚¹ãƒ¬ãƒƒãƒ‰ã§å‡¦ç†ã™ã‚‹ã‚ˆã†ã«å¤‰æ›´ã—ã¾ã™ï¼</p>\n<pre><code class=\"hljs language-swift\"><span class=\"hljs-keyword\">let</span> observable <span class=\"hljs-operator\">=</span> <span class=\"hljs-type\">Observable</span>&#x3C;<span class=\"hljs-type\">String</span>>.create { observer -> <span class=\"hljs-type\">Disposable</span> <span class=\"hljs-keyword\">in</span>\n\n  <span class=\"hljs-type\">DispatchQueue</span>.global(qos: .default).async {\n\n    <span class=\"hljs-type\">Thread</span>.sleep(forTimeInterval: <span class=\"hljs-number\">5</span>) <span class=\"hljs-comment\">// ...zzZ</span>\n\n    observer.onNext(<span class=\"hljs-string\">\"YO!ğŸ˜\"</span>)\n    observer.onCompleted()\n  }\n  <span class=\"hljs-keyword\">return</span> <span class=\"hljs-type\">Disposables</span>.create()\n}\n</code></pre>\n<p>ã€ŒYO!ã€ãŒã©ã®ã‚¹ãƒ¬ãƒƒãƒ‰ã‹ã‚‰æ¥ã¦ã„ã‚‹ã®ã‹çŸ¥ã‚ŠãŸã„ã®ã§ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ã‚’ä½œã£ã¦<code>subscribe</code>ã™ã‚‹å´ã‚’å°‘ã—å¤‰æ›´ã—ã¾ã™ï¼</p>\n<pre><code class=\"hljs language-swift\"><span class=\"hljs-keyword\">func</span> <span class=\"hljs-title function_\">which</span>() -> <span class=\"hljs-type\">String</span> {\n  <span class=\"hljs-keyword\">return</span> <span class=\"hljs-type\">Thread</span>.isMainThread <span class=\"hljs-operator\">?</span> <span class=\"hljs-string\">\"main\"</span> : <span class=\"hljs-string\">\"background\"</span>\n}\n</code></pre>\n<pre><code class=\"hljs language-swift\">observable.subscribe(onNext: { (message: <span class=\"hljs-type\">String</span>) <span class=\"hljs-keyword\">in</span>\n  <span class=\"hljs-built_in\">print</span>(<span class=\"hljs-string\">\"<span class=\"hljs-subst\">\\(message)</span> on <span class=\"hljs-subst\">\\(which())</span>\"</span>)\n})\n</code></pre>\n<pre><code class=\"hljs language-txt\">YO!ğŸ˜ on background\n</code></pre>\n<p>ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã‹ã‚‰ã€ŒYO!ã€ãŒå±Šãã¾ã—ãŸï¼</p>\n<p>main ã‚¹ãƒ¬ãƒƒãƒ‰ä»¥å¤–ã‹ã‚‰ UI ã«è§¦ã‚ã†ã¨ã™ã‚‹ã¨ System ã«æ€’ã‚‰ã‚Œã¦ã—ã¾ã„ã¾ã™ï¼ãªã®ã§åˆ¥ã‚¹ãƒ¬ãƒƒãƒ‰ã§çœ ã£ã¦ã‹ã‚‰ã€ŒYO!ã€ã®é€ä¿¡ã ã‘ã‚’ main ã‚¹ãƒ¬ãƒƒãƒ‰ã§è¡Œã†ã‚ˆã†ã«å¤‰æ›´ã—ã¾ã™ï¼</p>\n<pre><code class=\"hljs language-swift\"><span class=\"hljs-keyword\">let</span> observable <span class=\"hljs-operator\">=</span> <span class=\"hljs-type\">Observable</span>&#x3C;<span class=\"hljs-type\">String</span>>.create { observer -> <span class=\"hljs-type\">Disposable</span> <span class=\"hljs-keyword\">in</span>\n\n  <span class=\"hljs-type\">DispatchQueue</span>.global(qos: .default).async {\n\n    <span class=\"hljs-type\">Thread</span>.sleep(forTimeInterval: <span class=\"hljs-number\">5</span>)\n\n    <span class=\"hljs-type\">DispatchQueue</span>.main.async {\n      observer.onNext(<span class=\"hljs-string\">\"YO!ğŸ˜\"</span>)\n      observer.onCompleted()\n    }\n  }\n  <span class=\"hljs-keyword\">return</span> <span class=\"hljs-type\">Disposables</span>.create()\n}\n</code></pre>\n<pre><code class=\"hljs language-txt\">YO!ğŸ˜ on main\n</code></pre>\n<p>ã†ã¾ãã„ãã¾ã—ãŸï¼ã“ã‚Œã§ãƒãƒ³ãƒ–ãƒ­ãƒƒã‚­ãƒ³ã‚° YO!YO!ãŒå¯èƒ½ã«ãªã‚Šã¾ã—ãŸï¼</p>\n<p>ã•ã¦ï¼Œã“ã“ã¾ã§ã®ã€ŒYO!ã€ã‚’æŒ¯ã‚Šè¿”ã£ã¦ã¿ã¾ã™ï¼</p>\n<pre><code class=\"hljs language-swift\"><span class=\"hljs-keyword\">let</span> observable <span class=\"hljs-operator\">=</span> <span class=\"hljs-type\">Observable</span>&#x3C;<span class=\"hljs-type\">String</span>>.create { observer -> <span class=\"hljs-type\">Disposable</span> <span class=\"hljs-keyword\">in</span>\n\n  observer.onNext(<span class=\"hljs-string\">\"YO!ğŸ˜\"</span>) <span class=\"hljs-comment\">// where subscribe() is called</span>\n\n  <span class=\"hljs-type\">DispatchQueue</span>.global(qos: .default).async {\n\n    <span class=\"hljs-type\">Thread</span>.sleep(forTimeInterval: <span class=\"hljs-number\">5</span>)\n    observer.onNext(<span class=\"hljs-string\">\"YO!ğŸ˜\"</span>) <span class=\"hljs-comment\">// background</span>\n\n    <span class=\"hljs-type\">DispatchQueue</span>.main.async {\n      observer.onNext(<span class=\"hljs-string\">\"YO!ğŸ˜\"</span>) <span class=\"hljs-comment\">// main</span>\n      observer.onCompleted()\n    }\n  }\n  <span class=\"hljs-keyword\">return</span> <span class=\"hljs-type\">Disposables</span>.create()\n}\n</code></pre>\n<pre><code class=\"hljs language-txt\">YO!ğŸ˜ on main\nYO!ğŸ˜ on background\nYO!ğŸ˜ on main\n</code></pre>\n<p>ã„ã„æ„Ÿã˜ã§ã™ï¼</p>\n<h2>Schedulers</h2>\n<p>æ¬¡ã¯ã„ã‚ˆã„ã‚ˆ Scheduler ã‚’ä½¿ã„ã¾ã™ï¼Observable ã®<code>observeOn</code>ã«<code>MainScheduler</code>ã‚’æŒ‡å®šã—ã¾ã™ï¼</p>\n<pre><code class=\"hljs language-swift\">observable\n  .observeOn(<span class=\"hljs-type\">MainScheduler</span>.instance)\n  .subscribe(onNext: { (message: <span class=\"hljs-type\">String</span>) <span class=\"hljs-keyword\">in</span>\n    <span class=\"hljs-built_in\">print</span>(<span class=\"hljs-string\">\"<span class=\"hljs-subst\">\\(message)</span> (Here is <span class=\"hljs-subst\">\\(which())</span>)\"</span>)\n  })\n</code></pre>\n<pre><code class=\"hljs language-txt\">YO!ğŸ˜ (Here is main)\nYO!ğŸ˜ (Here is main)\nYO!ğŸ˜ (Here is main)\n</code></pre>\n<p><code>subscribe</code>ã®ä¸­ãŒå…¨ã¦ main ã‚¹ãƒ¬ãƒƒãƒ‰ã§å®Ÿè¡Œã•ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸï¼<code>MainScheduler</code>ã‚’æŒ‡å®šã—ãŸãŠã‹ã’ã§<code>DispatchQueue.main.async</code>ã¯ä¸è¦ã«ãªã‚Šã¾ã—ãŸï¼</p>\n<p>ã€ŒYO!ã€ãŒã©ã“ã‹ã‚‰æ¥ã¦ã„ã‚‹ã®ã‹ã‚ã‹ã‚‰ãªããªã£ã¦ã—ã¾ã£ãŸã®ã§å°‘ã—å¤‰æ›´ã‚’åŠ ãˆã¾ã™ï¼</p>\n<pre><code class=\"hljs language-swift\"><span class=\"hljs-keyword\">let</span> observable <span class=\"hljs-operator\">=</span> <span class=\"hljs-type\">Observable</span>&#x3C;<span class=\"hljs-type\">String</span>>.create { observer -> <span class=\"hljs-type\">Disposable</span> <span class=\"hljs-keyword\">in</span>\n\n  observer.onNext(<span class=\"hljs-string\">\"YO!ğŸ˜ from <span class=\"hljs-subst\">\\(which())</span>.\"</span>)\n\n  <span class=\"hljs-type\">DispatchQueue</span>.global(qos: .default).async {\n\n    <span class=\"hljs-type\">Thread</span>.sleep(forTimeInterval: <span class=\"hljs-number\">5</span>)\n\n    observer.onNext(<span class=\"hljs-string\">\"YO!ğŸ˜ from <span class=\"hljs-subst\">\\(which())</span>.\"</span>)\n    observer.onCompleted()\n  }\n  <span class=\"hljs-keyword\">return</span> <span class=\"hljs-type\">Disposables</span>.create()\n}\n</code></pre>\n<pre><code class=\"hljs language-txt\">YO!ğŸ˜ from main. (Here is main)\nYO!ğŸ˜ from background. (Here is main)\n</code></pre>\n<p><code>observeOn</code>ã®æŒ¯ã‚‹èˆã„ãŒã‚ã‹ã‚Šã¾ã—ãŸï¼</p>\n<p>æ¬¡ã«ï¼Œ<code>subscribeOn</code>ã§ Observable ã®å‡¦ç†ã‚’å®Ÿè¡Œã™ã‚‹ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’æŒ‡å®šã—ã¾ã™ï¼å…ˆã»ã©è¿°ã¹ãŸé€šã‚Šï¼ŒObservable ã®å‡¦ç†ã¯ï¼Œé€šå¸¸ã¯<code>subscribe</code>ã‚’å‘¼ã³å‡ºã—ãŸã‚¹ãƒ¬ãƒƒãƒ‰ã§å®Ÿè¡Œã•ã‚Œã¾ã™ï¼\nã—ã‹ã—<code>subscribeOn</code>ã‚’ä½¿ã†ã¨ã“ã‚Œã‚’å¤‰æ›´ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ï¼</p>\n<pre><code class=\"hljs language-swift\">observable\n  .subscribeOn(<span class=\"hljs-type\">ConcurrentDispatchQueueScheduler</span>(qos: .default))\n  .observeOn(<span class=\"hljs-type\">MainScheduler</span>.instance)\n  .subscribe(onNext: { (message: <span class=\"hljs-type\">String</span>) <span class=\"hljs-keyword\">in</span>\n    <span class=\"hljs-built_in\">print</span>(<span class=\"hljs-string\">\"<span class=\"hljs-subst\">\\(message)</span> (Here is <span class=\"hljs-subst\">\\(which())</span>)\"</span>)\n  })\n</code></pre>\n<pre><code class=\"hljs language-txt\">YO!ğŸ˜ from background. (Here is main)\nYO!ğŸ˜ from background. (Here is main)\n</code></pre>\n<p>ã‚¹ãƒªãƒ¼ãƒ—ã®å‡¦ç†ã‚’ DispatchQueue ã§æŒ‡å®šã™ã‚‹å¿…è¦ãŒç„¡ããªã‚Šã¾ã™ã®ã§ï¼ŒObservable ã¯ã“ã†ãªã‚Šã¾ã™ï¼</p>\n<pre><code class=\"hljs language-swift\"><span class=\"hljs-keyword\">let</span> observable <span class=\"hljs-operator\">=</span> <span class=\"hljs-type\">Observable</span>&#x3C;<span class=\"hljs-type\">String</span>>.create { observer -> <span class=\"hljs-type\">Disposable</span> <span class=\"hljs-keyword\">in</span>\n  <span class=\"hljs-type\">Thread</span>.sleep(forTimeInterval: <span class=\"hljs-number\">5</span>)\n  observer.onNext(<span class=\"hljs-string\">\"YO!ğŸ˜ from <span class=\"hljs-subst\">\\(which())</span>.\"</span>)\n  observer.onCompleted()\n  <span class=\"hljs-keyword\">return</span> <span class=\"hljs-type\">Disposables</span>.create()\n}\n</code></pre>\n<p>ã“ã‚Œã¯å†’é ­ã«å‡ºã¦æ¥ãŸ Observable ã§ã™ï¼Schedulers ã‚’åˆ©ç”¨ã™ã‚Œã°ç°¡å˜ã«ãƒãƒ³ãƒ–ãƒ­ãƒƒã‚­ãƒ³ã‚° YO!YO!ãŒå‡ºæ¥ã¾ã™ï¼ä»¥ä¸Šã§ã™ï¼</p>\n<p>ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã¯<a href=\"https://gist.github.com/chooblarin/a041328422870581c616f32717d80393\">Gist</a> ã«ç½®ã„ã¦ãŠãã¾ã™ï¼</p>\n<h2>å‚è€ƒ</h2>\n<ul>\n<li><a href=\"https://github.com/ReactiveX/RxSwift/blob/master/Documentation/Schedulers.md\">RxSwift/Schedulers.md at master Â· ReactiveX/RxSwift</a></li>\n<li><a href=\"https://swiftpearls.com/RxSwift-for-dummies-2-Operators.html\">RxSwift For Dummies ğŸ¥ Part 2</a></li>\n</ul>"}},"__N_SSG":true}