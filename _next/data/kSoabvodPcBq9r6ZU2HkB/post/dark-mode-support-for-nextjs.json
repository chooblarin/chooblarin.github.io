{"pageProps":{"postContent":{"title":"ダークモードに対応する","date":"2020-12-01T00:00:00+00:00","slug":"dark-mode-support-for-nextjs","tags":["Blog","JavaScript"],"draft":false,"content":"<p>この記事は<a href=\"https://adventar.org/calendars/5034\">フラー Advent Calendar 2020</a> の1日目の記事です。</p>\n<p>先日，Next.jsに移行した本ブログにダークモード (dark mode) 対応を追加しました。</p>\n<h2>基本の知識</h2>\n<p>ユーザーの端末がOSで設定している値を参照するには，<code>prefers-color-scheme</code> <a href=\"https://developer.mozilla.org/en-US/docs/Web/CSS/@media/prefers-color-scheme\">*</a> というCSSメディアを参照します。CSSの一例を以下に示します。</p>\n<pre><code class=\"hljs language-css\"><span class=\"hljs-keyword\">@media</span> (<span class=\"hljs-attribute\">prefers-color-scheme</span>: dark) {\n  <span class=\"hljs-comment\">/* ダークモードのスタイルを追加する */</span>\n  <span class=\"hljs-selector-tag\">body</span> {\n    <span class=\"hljs-attribute\">color</span>: white;\n    <span class=\"hljs-attribute\">background</span>: black;\n  }\n}\n<span class=\"hljs-keyword\">@media</span> (<span class=\"hljs-attribute\">prefers-color-scheme</span>: light) {\n  <span class=\"hljs-comment\">/* ライトモードのスタイルを追加する */</span>\n  <span class=\"hljs-selector-tag\">body</span> {\n    <span class=\"hljs-attribute\">color</span>: black;\n    <span class=\"hljs-attribute\">background</span>: yellow;\n  }\n}\n</code></pre>\n<p>CSSのスタイルを全て <code>prefers-color-scheme</code> のメディアクエリで切り替えればこれで良いです。しかし実際にはJavaScriptのプログラムで色テーマを制御したい場合も少なくありません。JavaScriptからアクセスするには以下のようにします。</p>\n<pre><code class=\"hljs language-js\"><span class=\"hljs-keyword\">if</span> (<span class=\"hljs-variable language_\">window</span>.<span class=\"hljs-title function_\">matchMedia</span>(<span class=\"hljs-string\">\"(prefers-color-scheme: dark)\"</span>).<span class=\"hljs-property\">matches</span>) {\n  <span class=\"hljs-comment\">// ダークモードのときの処理</span>\n}\n</code></pre>\n<h2>Next.js とダークモード対応</h2>\n<p>先述の <code>prefers-color-scheme</code> を用いて，以下のような関数を定義したとします。</p>\n<pre><code class=\"hljs language-js\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title function_\">getPreferredColorScheme</span>(<span class=\"hljs-params\"></span>) {\n  <span class=\"hljs-keyword\">const</span> mql = <span class=\"hljs-variable language_\">window</span>.<span class=\"hljs-title function_\">matchMedia</span>(<span class=\"hljs-string\">\"(prefers-color-scheme: dark)\"</span>);\n  <span class=\"hljs-keyword\">return</span> mql.<span class=\"hljs-property\">matches</span> ? <span class=\"hljs-string\">\"dark\"</span> : <span class=\"hljs-string\">\"light\"</span>;\n}\n</code></pre>\n<p>しかしNext.jsのアプリケーションではReactコンポーネントでこの関数を実行するとエラーになってしまいます。Next.jsはビルド時にプリレンダリングを行うので，Nodeの環境で <code>window</code> オブジェクトに参照しようとして <code>ReferenceError</code> になってしまうのです。</p>\n<p>この問題を回避する方法を調べてみたところ，以下のブログ記事にとても詳しくまとまっていました（Gatsbyでの回避策ですが，根本的な問題は同じです）。</p>\n<ul>\n<li><a href=\"https://www.joshwcomeau.com/react/dark-mode/\">\"How to add dark mode to a Gatsby site\"</a></li>\n</ul>\n<p>また，以下のようなダークモード対応を簡単にするためのReact Hookライブラリも存在します。（これを使用して対応しても良かったのですが，せっかくなので自分で実装してみることにします。）</p>\n<ul>\n<li><a href=\"https://github.com/donavon/use-dark-mode\">\"donavon/use-dark-mode: A custom React Hook to help you implement a \"dark mode\" component.\"</a></li>\n</ul>\n<p>この2つの実装方法を参考にして，本ブログのダークモード対応を行いました。</p>\n<h3>flashを防止する</h3>\n<p>先に述べた通り，Next.jsが静的ページを生成する時点では，\"dark\" と \"light\" のどちらのテーマでプリレンダリングを実行すれば良いのかがわかりません。一時的に \"light\" テーマでページを生成し，クライアント側の情報を取得してからテーマの色をセットするのでは，一瞬正しくない色がチラついて表示されてしまいます。</p>\n<p>そこで，以下の手順でこれを回避します。</p>\n<ul>\n<li>CSS Variablesを使ったスタイルでプリレンダリング</li>\n<li>クライアントでページがロードされてから即座に実行するスクリプトを定義</li>\n<li>そのスクリプトで \"dark\" か \"light\" を判定してCSS Variablesをセットする</li>\n</ul>\n<p>まず最初に以下のようなスタイルを追加します。</p>\n<pre><code class=\"hljs language-css\"><span class=\"hljs-selector-tag\">body</span> {\n  <span class=\"hljs-attribute\">color</span>: <span class=\"hljs-built_in\">var</span>(--color-text);\n  <span class=\"hljs-attribute\">background</span>: <span class=\"hljs-built_in\">var</span>(--color-background);\n}\n</code></pre>\n<p>次に，カラーテーマを判別するためにクライアント側でのみ実行するスクリプト <code>ColorThemeScript</code> を作成します。</p>\n<pre><code class=\"hljs language-ts\"><span class=\"hljs-keyword\">const</span> <span class=\"hljs-title class_\">ColorThemeScript</span>: <span class=\"hljs-title class_\">React</span>.<span class=\"hljs-property\">FC</span> = <span class=\"hljs-function\">() =></span> (\n  <span class=\"xml\"><span class=\"hljs-tag\">&#x3C;<span class=\"hljs-name\">script</span>\n    <span class=\"hljs-attr\">dangerouslySetInnerHTML</span>=<span class=\"hljs-string\">{{</span>\n      <span class=\"hljs-attr\">__html:</span> `\n      (<span class=\"hljs-attr\">function</span>() {\n        <span class=\"hljs-attr\">var</span> <span class=\"hljs-attr\">preferDarkQuery</span> = <span class=\"hljs-string\">'(prefers-color-scheme: dark)'</span>;\n        <span class=\"hljs-attr\">var</span> <span class=\"hljs-attr\">mql</span> = <span class=\"hljs-string\">window.matchMedia(preferDarkQuery);</span>\n\n        <span class=\"hljs-attr\">...</span>\n\n        <span class=\"hljs-attr\">var</span> <span class=\"hljs-attr\">colorMode</span> = <span class=\"hljs-string\">getInitialColorMode();</span>\n        <span class=\"hljs-attr\">setThemeColors</span>(<span class=\"hljs-attr\">colorMode</span>);\n      })();\n    `,\n    }}\n  /></span></span>\n);\n</code></pre>\n<p>このスクリプトは先ほど紹介した <a href=\"https://github.com/donavon/use-dark-mode/blob/29590271bb3a74f08975181c5ed68bd5a210ef83/noflash.js.txt\">donavon/use-dark-mode</a> から拝借します。</p>\n<p>そしてNext.jsのカスタムドキュメント (<code>_document</code>) に <code>&#x3C;ColorThemeScript /></code> を挿入します。</p>\n<pre><code class=\"hljs language-ts\"><span class=\"hljs-keyword\">export</span> <span class=\"hljs-keyword\">default</span> <span class=\"hljs-keyword\">class</span> <span class=\"hljs-title class_\">CustomDocument</span> <span class=\"hljs-keyword\">extends</span> <span class=\"hljs-title class_ inherited__\">Document</span> {\n  <span class=\"hljs-title function_\">render</span>(<span class=\"hljs-params\"></span>) {\n    <span class=\"hljs-keyword\">return</span> (\n      <span class=\"xml\"><span class=\"hljs-tag\">&#x3C;<span class=\"hljs-name\">Html</span>></span>\n        <span class=\"hljs-tag\">&#x3C;<span class=\"hljs-name\">Head</span> /></span>\n        <span class=\"hljs-tag\">&#x3C;<span class=\"hljs-name\">body</span>></span>\n          {/* bodyタグの先頭に挿入する */}\n          <span class=\"hljs-tag\">&#x3C;<span class=\"hljs-name\">ColorThemeScript</span> /></span>\n          <span class=\"hljs-tag\">&#x3C;<span class=\"hljs-name\">Main</span> /></span>\n          <span class=\"hljs-tag\">&#x3C;<span class=\"hljs-name\">NextScript</span> /></span>\n        <span class=\"hljs-tag\">&#x3C;/<span class=\"hljs-name\">body</span>></span>\n      <span class=\"hljs-tag\">&#x3C;/<span class=\"hljs-name\">Html</span>></span></span>\n    );\n  }\n}\n</code></pre>\n<p>クライアント側では <code>ColorThemeScript</code> のスクリプトによって決定した情報をReact.Contextに保存してアクセスできるようにします。この実装は先ほど紹介したブログ記事 <a href=\"https://www.joshwcomeau.com/react/dark-mode/\">\"How to add dark mode to a Gatsby site\"</a> のコードを参考にしました。</p>\n<pre><code class=\"hljs language-ts\"><span class=\"hljs-keyword\">const</span> <span class=\"hljs-title class_\">ColorThemeContext</span> = <span class=\"hljs-title class_\">React</span>.<span class=\"hljs-property\">createContext</span>&#x3C;<span class=\"hljs-title class_\">ColorTheme</span>>(<span class=\"hljs-literal\">undefined</span>);\n\n<span class=\"hljs-keyword\">const</span> <span class=\"hljs-title class_\">ColorThemeProvider</span>: <span class=\"hljs-title class_\">React</span>.<span class=\"hljs-property\">FC</span> = <span class=\"hljs-function\">(<span class=\"hljs-params\">{ children }</span>) =></span> {\n  <span class=\"hljs-keyword\">const</span> [colorMode, setColorMode] = <span class=\"hljs-title class_\">React</span>.<span class=\"hljs-title function_\">useState</span>(<span class=\"hljs-literal\">undefined</span>);\n  <span class=\"hljs-title class_\">React</span>.<span class=\"hljs-title function_\">useEffect</span>(<span class=\"hljs-function\">() =></span> {\n    <span class=\"hljs-keyword\">const</span> root = <span class=\"hljs-variable language_\">window</span>.<span class=\"hljs-property\">document</span>.<span class=\"hljs-property\">documentElement</span>;\n    <span class=\"hljs-keyword\">const</span> initialColorValue = root.<span class=\"hljs-property\">style</span>.<span class=\"hljs-title function_\">getPropertyValue</span>(\n      <span class=\"hljs-string\">\"--initial-color-mode\"</span>\n    );\n    <span class=\"hljs-title function_\">setColorMode</span>(initialColorValue);\n  }, []);\n\n  <span class=\"hljs-keyword\">const</span> <span class=\"hljs-title function_\">changeColorMode</span> = (<span class=\"hljs-params\">mode: <span class=\"hljs-built_in\">string</span></span>) => {\n    ...\n  }\n\n  <span class=\"hljs-keyword\">return</span> (\n    <span class=\"xml\"><span class=\"hljs-tag\">&#x3C;<span class=\"hljs-name\">ColorThemeContext.Provider</span> <span class=\"hljs-attr\">value</span>=<span class=\"hljs-string\">{{</span> <span class=\"hljs-attr\">colorMode</span>, <span class=\"hljs-attr\">changeColorMode</span> }}></span>\n      {children}\n    <span class=\"hljs-tag\">&#x3C;/<span class=\"hljs-name\">ColorThemeContext.Provider</span>></span></span>\n  );\n};\n</code></pre>\n<p><code>ColorThemeProvider</code> はNext.jsのカスタムApp (<code>_app</code>) に追加します。</p>\n<pre><code class=\"hljs language-ts\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title function_\">App</span>(<span class=\"hljs-params\">{ Component, pageProps }: AppProps</span>) {\n  ...\n  <span class=\"hljs-keyword\">return</span> (\n    <span class=\"xml\"><span class=\"hljs-tag\">&#x3C;<span class=\"hljs-name\">ColorThemeProvider</span>></span>\n      <span class=\"hljs-tag\">&#x3C;<span class=\"hljs-name\">Component</span> {<span class=\"hljs-attr\">...pageProps</span>} /></span>\n    <span class=\"hljs-tag\">&#x3C;/<span class=\"hljs-name\">ColorThemeProvider</span>></span></span>\n  );\n}\n</code></pre>\n<p>これで対応は完了です。</p>\n<h2>まとめ</h2>\n<p>CSS Variablesを使ってダークモードに対応しました。ユーザーがトグルスイッチで明示的に切り替えたテーマはlocalStorageに保存しており，次回以降のサイト訪問時には優先的に選択されるように実装しています。</p>\n<p>最初はlocalStorageの代わりにIndexedDBを使おうと考えたのですが，非同期処理が面倒だったので辞めました。パフォーマンスにはほぼ影響無いと思いますが，実装方法の良いアイディアを見つけたら挑戦してみたいと思います。</p>\n<p>余談ですが，ユーザーのOS設定 (<code>prefers-color-scheme</code> で取得できる値) を参照しているのだからUIで切り替える機能は不要だという意見もあるようです。ところがFirefoxのfingerprinting対策オプション <a href=\"https://wiki.mozilla.org/Security/Fingerprinting#Terse_List:~:text=prefers%2Dcolor%2Dscheme%20always%20says%20light%20mode.\">*</a> が有効になっていると，この値は常に \"light\" モードとして上書きされるようで，カラーテーマ切り替えのUIがあっても良いのかも知れません。</p>"}},"__N_SSG":true}