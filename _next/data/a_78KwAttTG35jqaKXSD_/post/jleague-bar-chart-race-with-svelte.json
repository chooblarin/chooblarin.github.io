{"pageProps":{"postContent":{"title":"今年のJリーグのBar Chart Raceをつくった","date":"2021-12-01T00:00:00+00:00","slug":"jleague-bar-chart-race-with-svelte","tags":["Blog","JavaScript"],"draft":false,"content":"<p>この記事は<a href=\"https://qiita.com/advent-calendar/2021/fuller-inc\">フラー株式会社 Advent Calendar 2021</a> の1日目の記事です。</p>\n<p>2021年のJ2の順位変動を第1節から振り返るデータ可視化をやってみました。（たくさんの感動をありがとうアルビレックス！）</p>\n<blockquote class=\"twitter-tweet\"><p lang=\"ja\" dir=\"ltr\">J2リーグのデータでBar Chart Raceつくったぞ。 <a href=\"https://t.co/VH6WW4SbRS\">pic.twitter.com/VH6WW4SbRS</a></p>&mdash; Sota Hatakeyama (@chooblarin) <a href=\"https://twitter.com/chooblarin/status/1465331402501615620?ref_src=twsrc%5Etfw\">November 29, 2021</a></blockquote>\n<p>完成したデモは<a href=\"https://chooblarin.github.io/jleague-bar-chart-race/\">こちら</a>です。</p>\n<h2>SvelteとBar Chart Race</h2>\n<p>Svelte Summit Spring 2021で \"<a href=\"https://www.youtube.com/watch?v=fnr9XWvjJHw&#x26;t=6369s\">Declarative Data Visualization</a>\" という面白いトークがありました。今回はこのトークの内容を参考にしてJリーグデータのBar Chart Raceをつくってみようと思います。</p>\n<p>Svelteと<a href=\"https://d3js.org/\">D3.js</a>を組み合わせて使用しますが，使うのは<code>scaleLinear</code>のみです。棒グラフの配置と横軸のticksを描くために使用します。また，SVGではなくHTMLを使います。棒グラフや軸はdiv要素で表現します。棒の内部先端にテキストを配置するような処理はSVGよりもボックスモデルのレイアウトの方が簡単に実装できます。</p>\n<h2>データを集める</h2>\n<p><a href=\"https://data.j-league.or.jp/\">J. League Data Site</a>でJリーグの公式記録を調べることができます。こちらのサイトの各節ごとの順位表からデータセットをつくりました。Webクローラーのソースコードは<a href=\"https://github.com/chooblarin/jleague-stats-crawler\">こちら</a>のリポジトリで公開しています。</p>\n<p><a href=\"https://deno.land/x/puppeteer\">deno-puppeteer</a> というDeno上で動くPuppeteerを使用しました。Denoはブラウザ標準との互換を目指しているのでURLのパース処理が簡単でした。</p>\n<p>集まったデータはこんな見た目をしています。</p>\n<pre><code class=\"hljs language-json\"><span class=\"hljs-punctuation\">[</span>\n  <span class=\"hljs-punctuation\">{</span>\n    <span class=\"hljs-attr\">\"section\"</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-punctuation\">{</span> <span class=\"hljs-attr\">\"label\"</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">\"第１節\"</span><span class=\"hljs-punctuation\">,</span> <span class=\"hljs-attr\">\"value\"</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">\"1\"</span> <span class=\"hljs-punctuation\">}</span><span class=\"hljs-punctuation\">,</span>\n    <span class=\"hljs-attr\">\"rankRecords\"</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-punctuation\">[</span>\n      <span class=\"hljs-punctuation\">{</span> <span class=\"hljs-attr\">\"id\"</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">\"niigata\"</span><span class=\"hljs-punctuation\">,</span> <span class=\"hljs-attr\">\"rank\"</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-number\">1</span><span class=\"hljs-punctuation\">,</span> <span class=\"hljs-attr\">\"name\"</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">\"アルビレックス新潟\"</span><span class=\"hljs-punctuation\">,</span> <span class=\"hljs-attr\">\"points\"</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-number\">3</span> <span class=\"hljs-punctuation\">}</span><span class=\"hljs-punctuation\">,</span>\n      <span class=\"hljs-punctuation\">{</span> <span class=\"hljs-attr\">\"id\"</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">\"tokyov\"</span><span class=\"hljs-punctuation\">,</span> <span class=\"hljs-attr\">\"rank\"</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-number\">2</span><span class=\"hljs-punctuation\">,</span> <span class=\"hljs-attr\">\"name\"</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">\"東京ヴェルディ\"</span><span class=\"hljs-punctuation\">,</span> <span class=\"hljs-attr\">\"points\"</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-number\">3</span> <span class=\"hljs-punctuation\">}</span><span class=\"hljs-punctuation\">,</span>\n      ...\n    <span class=\"hljs-punctuation\">]</span>\n  <span class=\"hljs-punctuation\">}</span><span class=\"hljs-punctuation\">,</span>\n  <span class=\"hljs-punctuation\">{</span>\n  <span class=\"hljs-attr\">\"section\"</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-punctuation\">{</span> <span class=\"hljs-attr\">\"label\"</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">\"第２節\"</span><span class=\"hljs-punctuation\">,</span> <span class=\"hljs-attr\">\"value\"</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">\"2\"</span> <span class=\"hljs-punctuation\">}</span><span class=\"hljs-punctuation\">,</span>\n  <span class=\"hljs-attr\">\"rankRecords\"</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-punctuation\">[</span>\n    <span class=\"hljs-punctuation\">{</span> <span class=\"hljs-attr\">\"id\"</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">\"niigata\"</span><span class=\"hljs-punctuation\">,</span> <span class=\"hljs-attr\">\"rank\"</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-number\">1</span><span class=\"hljs-punctuation\">,</span> <span class=\"hljs-attr\">\"name\"</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">\"アルビレックス新潟\"</span><span class=\"hljs-punctuation\">,</span> <span class=\"hljs-attr\">\"points\"</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-number\">6</span> <span class=\"hljs-punctuation\">}</span><span class=\"hljs-punctuation\">,</span>\n    <span class=\"hljs-punctuation\">{</span> <span class=\"hljs-attr\">\"id\"</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">\"ryukyu\"</span><span class=\"hljs-punctuation\">,</span> <span class=\"hljs-attr\">\"rank\"</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-number\">2</span><span class=\"hljs-punctuation\">,</span> <span class=\"hljs-attr\">\"name\"</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">\"ＦＣ琉球\"</span><span class=\"hljs-punctuation\">,</span> <span class=\"hljs-attr\">\"points\"</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-number\">6</span> <span class=\"hljs-punctuation\">}</span><span class=\"hljs-punctuation\">,</span>\n    ...\n  <span class=\"hljs-punctuation\">]</span>\n  ...\n<span class=\"hljs-punctuation\">]</span>\n</code></pre>\n<h2>アプリをつくっていく</h2>\n<p>データの準備ができたのでアプリをつくっていきます。Viteの <code>svelte-ts</code> テンプレートを使用します。</p>\n<pre><code class=\"hljs language-sh\">yarn create vite app --template svelte-ts\n</code></pre>\n<p>前述したSvelte Summitのトークと本家のデモアプリの<a href=\"https://github.com/russellgoldenberg/svelte-bar-chart-race\">ソースコード</a>をほぼマネてつくりました。</p>\n<p><a href=\"https://github.com/chooblarin/jleague-bar-chart-race\">https://github.com/chooblarin/jleague-bar-chart-race</a></p>\n<p>グラフのアニメーションは <code>svelte/motion</code> モジュールの <a href=\"https://svelte.dev/docs#tweened\"><code>tweened</code></a>によって実現しており，<code>d3-transition</code>などは使用していません。<code>tweened</code>は書き込み可能なstoreで，値を変更すると変更前と変更後の値を補間しながら変化します。配列やオブジェクトを書き込むこともでき，2つの値が同じ形をしていれば「葉」の数値を補間してくれます。</p>\n<p>例えば今回のデータでは，以下のように各節での順位を以下のように更新していきます。配列の場合は要素の並びを保存しないとうまく補間できないので注意が必要です。</p>\n<pre><code class=\"hljs language-ts\"><span class=\"hljs-comment\">// 第1節のデータ</span>\n<span class=\"hljs-keyword\">const</span> store = <span class=\"hljs-title hljs-function\">tweened</span>([\n  { <span class=\"hljs-attr\">id</span>: <span class=\"hljs-string\">\"niigata\"</span>, <span class=\"hljs-attr\">rank</span>: <span class=\"hljs-number\">1</span>, <span class=\"hljs-attr\">points</span>: <span class=\"hljs-number\">3</span> },\n  { <span class=\"hljs-attr\">id</span>: <span class=\"hljs-string\">\"tokyov\"</span>,  <span class=\"hljs-attr\">rank</span>: <span class=\"hljs-number\">2</span>, <span class=\"hljs-attr\">points</span>: <span class=\"hljs-number\">3</span> }\n]);\n\n<span class=\"hljs-comment\">// 第2節のデータ</span>\nstore.<span class=\"hljs-title hljs-function\">set</span>([\n  { <span class=\"hljs-attr\">id</span>: <span class=\"hljs-string\">\"niigata\"</span>, <span class=\"hljs-attr\">rank</span>: <span class=\"hljs-number\">1</span>, <span class=\"hljs-attr\">points</span>: <span class=\"hljs-number\">6</span> },\n  { <span class=\"hljs-attr\">id</span>: <span class=\"hljs-string\">\"tokyov\"</span>,  <span class=\"hljs-attr\">rank</span>: <span class=\"hljs-number\">8</span>, <span class=\"hljs-attr\">points</span>: <span class=\"hljs-number\">3</span> }\n]);\n</code></pre>\n<p>すると，storeの値は <code>\"niigata\"</code> の <code>\"points\"</code> は3から6に，<code>\"tokyov\"</code> の <code>\"rank\"</code> は2から8に，線形補間しながら変化します。このstoreを購読しているコンポーネントは，その変化に応じてUIをアップデートするだけで簡単にTweenアニメーションを実現できます。</p>\n<p>下の画像のように，シークバーの変化に合わせて節のデータを<code>tweened</code>のstoreに書き込むだけでスムーズなアニメーションができました。</p>\n<img src=\"/images/20211201/jleague-bar-chart-seekbar-demo.gif\" width=\"320\" height=\"300\" style=\"margin: 0 auto;\" />\n<h2>おわりに</h2>\n<p>Svelteはリアクティブな変数や双方向データバインディングを簡単に利用する手段を提供しているので，Bar Chart Raceのようなアプリを少ないコード量で実装できました。</p>\n<p>実は来週末にJ2の最終節の試合が行われます。試合結果が出たら反映しておこうと思います。</p>"}},"__N_SSG":true}