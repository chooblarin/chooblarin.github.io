<!DOCTYPE html><html><head><script async="" src="https://www.googletagmanager.com/gtag/js?id=UA-62520326-2"></script><script>
            window.dataLayer = window.dataLayer || [];
            function gtag(){dataLayer.push(arguments);}
            gtag('js', new Date());
            gtag('config', 'UA-62520326-2', {
              page_path: window.location.pathname,
              anonymize_ip: true
            });
          </script><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><meta name="description" content="Sympathy driven development"/><meta property="og:url" content="https://chooblarin.github.io"/><meta property="og:type" content="website"/><meta property="og:description" content="Sympathy driven development"/><meta property="og:image" content="og-default.png"/><meta property="og:image:alt" content="chooblarin&#x27;s blog"/><meta property="og:image:width" content="1280"/><meta property="og:image:height" content="675"/><meta property="og:site_name" content="chooblarin&#x27;s blog"/><meta name="google-site-verification" content="5MMy9toPN2P8O6xmRyiBp-l97-pCGSnLGS2AwiUdWpI"/><meta name="theme-color" content="#ffffff"/><link rel="icon" type="image/svg+xml" href="favicon.svg"/><link rel="mask-icon" href="mask-icon.svg" color="#000000"/><link rel="apple-touch-icon" href="apple-touch-icon.png"/><link rel="manifest" href="/site.webmanifest"/><title>ElixirでMIDIファイルをパースする | chooblarin&#x27;s blog</title><meta name="robots" content="index,follow"/><meta name="googlebot" content="index,follow"/><meta property="og:title" content="ElixirでMIDIファイルをパースする"/><script async="" src="https://platform.twitter.com/widgets.js" charSet="utf-8"></script><script async="" src="https://static.codepen.io/assets/embed/ei.js" charSet="utf-8"></script><script async="" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML" charSet="utf-8"></script><script type="text/x-mathjax-config">
MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [['$','$']],
    displayMath: [['$$','$$']],
    extensions: ["[Contrib]/a11y/accessibility-menu.js"],
    menuSettings: {
      collapsible: true,
      autocollapse: true,
      explorer: true
    },
    processEscapes: true
  },
  CommonHTML: { matchFontHeight: false },
  displayAlign: "left",
  displayIndent: "2em"
});
</script><meta name="next-head-count" content="25"/><link rel="preload" href="/_next/static/css/1b64d207d85c9487d242.css" as="style"/><link rel="stylesheet" href="/_next/static/css/1b64d207d85c9487d242.css" data-n-g=""/><link rel="preload" href="/_next/static/css/b0913d6b4f1bdb4d70a1.css" as="style"/><link rel="stylesheet" href="/_next/static/css/b0913d6b4f1bdb4d70a1.css" data-n-p=""/><noscript data-n-css=""></noscript><link rel="preload" href="/_next/static/chunks/main-678aa2b69d2ab79ecb76.js" as="script"/><link rel="preload" href="/_next/static/chunks/webpack-e067438c4cf4ef2ef178.js" as="script"/><link rel="preload" href="/_next/static/chunks/framework.1cc9dd07c455eb544511.js" as="script"/><link rel="preload" href="/_next/static/chunks/f1c7a11d82ab5aeae255133ab9a9dd72095cfbe8.e1f58f7275138f941609.js" as="script"/><link rel="preload" href="/_next/static/chunks/be0ee40335aab5b90e46c407218b7ebff3be96c3.f5754105fd8cc37bf292.js" as="script"/><link rel="preload" href="/_next/static/chunks/af34e2db61f97cedc6ebfbaa0d751a83f9f0d9f6.7c780aded457d8a8445d.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/_app-e01041ccc1fb5d0e6fd2.js" as="script"/><link rel="preload" href="/_next/static/chunks/305bf1217467fbfb8d27f2d195337c27f206dc2e.c6fc4c67fa9d059cb2b1.js" as="script"/><link rel="preload" href="/_next/static/chunks/dc565b348471f1cc9a369b64c164a9c4498f98d4.5a431597bfee0da91e6a.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/post/%5Bslug%5D-c6759ca9b0a156e6f39c.js" as="script"/></head><body><script>
      (function() {
        var preferDarkQuery = '(prefers-color-scheme: dark)';
        var mql = window.matchMedia(preferDarkQuery);
        var supportsColorSchemeQuery = mql.media === preferDarkQuery;

        function getInitialColorMode() {
          try {
            var persistedColorPreference = localStorage.getItem('color-mode');
            if (persistedColorPreference) {
              return persistedColorPreference;
            }
          } catch (err) {}

          if (supportsColorSchemeQuery) {
            return mql.matches ? 'dark' : 'light';
          }
          return 'light';
        }

        function setThemeColors(mode) {
          var root = document.documentElement;
          root.style.setProperty('--initial-color-mode', mode);
          root.style.setProperty(
            '--color-text',
            mode === 'light'
              ? '#232323'
              : '#ffffff'
          );
          root.style.setProperty(
            '--color-sub-text',
            mode === 'light'
              ? '#767676'
              : '#8a8a8a'
          );
          root.style.setProperty(
            '--color-background',
            mode === 'light'
              ? '#ffffff'
              : '#1e1e1e'
          );
          root.style.setProperty(
            '--color-primary',
            mode === 'light'
              ? '#932ab5'
              : '#d88dff'
          );
        }

        var colorMode = getInitialColorMode();
        setThemeColors(colorMode);

        if (supportsColorSchemeQuery) {
          mql.addListener(function (ev) {
            setThemeColors(ev.matches ? 'dark' : 'light');
          });
        }
      })();
    </script><div id="__next"><div class="css-0"><style data-emotion-css="1d6rryl">.css-1d6rryl{color:#4a4a4a;color:var(--color-text);position:relative;padding:12px 8px;}</style><header class="css-1d6rryl"><style data-emotion-css="1ahgyoq">.css-1ahgyoq{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-pack:end;-webkit-justify-content:flex-end;-ms-flex-pack:end;justify-content:flex-end;position:absolute;top:0;right:0;left:0;max-width:740px;margin:20px auto;padding:0 20px;}</style><div class="css-1ahgyoq"></div><style data-emotion-css="umr12z">.css-umr12z{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;max-width:740px;margin:72px auto;}</style><section class="css-umr12z"><style data-emotion-css="4g6ai3">.css-4g6ai3{cursor:pointer;}</style><a class="css-4g6ai3"><style data-emotion-css="1pt35et">.css-1pt35et{width:207px;padding:10px 0 20px;color:var(--color-text);}</style><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 207 68" class="css-1pt35et"><title>chooblarin’s blog</title><g transform="translate(-57, -32)" fill="currentColor"><path d="M70.1,42.2 L60.5,42.2 L60.5,39 L70.1,39 L70.1,42.2 Z M60.5,51.8 L57.3,51.8 L57.3,42.2 L60.5,42.2 L60.5,51.8 Z M70.1,55 L60.5,55 L60.5,51.8 L70.1,51.8 L70.1,55 Z M79.7,42.2 L82.9,42.2 L82.9,45.4 L79.7,45.4 L79.7,55 L76.5,55 L76.5,32.6 L79.7,32.6 L79.7,42.2 Z M89.3,42.2 L82.9,42.2 L82.9,39 L89.3,39 L89.3,42.2 Z M92.5,55 L89.3,55 L89.3,42.2 L92.5,42.2 L92.5,55 Z M111.7,42.2 L102.1,42.2 L102.1,39 L111.7,39 L111.7,42.2 Z M102.1,51.8 L98.9,51.8 L98.9,42.2 L102.1,42.2 L102.1,51.8 Z M114.9,51.8 L111.7,51.8 L111.7,42.2 L114.9,42.2 L114.9,51.8 Z M111.7,55 L102.1,55 L102.1,51.8 L111.7,51.8 L111.7,55 Z M134.1,42.2 L124.5,42.2 L124.5,39 L134.1,39 L134.1,42.2 Z M124.5,51.8 L121.3,51.8 L121.3,42.2 L124.5,42.2 L124.5,51.8 Z M137.3,51.8 L134.1,51.8 L134.1,42.2 L137.3,42.2 L137.3,51.8 Z M134.1,55 L124.5,55 L124.5,51.8 L134.1,51.8 L134.1,55 Z M146.9,39 L156.5,39 L156.5,42.2 L146.9,42.2 L146.9,51.8 L156.5,51.8 L156.5,55 L143.7,55 L143.7,32.6 L146.9,32.6 L146.9,39 Z M159.7,51.8 L156.5,51.8 L156.5,42.2 L159.7,42.2 L159.7,51.8 Z M169.3,51.8 L166.1,51.8 L166.1,32.6 L169.3,32.6 L169.3,51.8 Z M172.5,55 L169.3,55 L169.3,51.8 L172.5,51.8 L172.5,55 Z M188.5,42.2 L178.9,42.2 L178.9,39 L188.5,39 L188.5,42.2 Z M191.7,55 L178.9,55 L178.9,51.8 L188.5,51.8 L188.5,48.6 L178.9,48.6 L178.9,45.4 L188.5,45.4 L188.5,42.2 L191.7,42.2 L191.7,55 Z M178.9,51.8 L175.7,51.8 L175.7,48.6 L178.9,48.6 L178.9,51.8 Z M201.3,42.2 L204.5,42.2 L204.5,45.4 L201.3,45.4 L201.3,55 L198.1,55 L198.1,39 L201.3,39 L201.3,42.2 Z M210.9,42.2 L204.5,42.2 L204.5,39 L210.9,39 L210.9,42.2 Z M218.9,35.8 L215.7,35.8 L215.7,32.6 L218.9,32.6 L218.9,35.8 Z M218.9,55 L215.7,55 L215.7,39 L218.9,39 L218.9,55 Z M238.1,42.2 L228.5,42.2 L228.5,39 L238.1,39 L238.1,42.2 Z M228.5,55 L225.3,55 L225.3,42.2 L228.5,42.2 L228.5,55 Z M241.3,55 L238.1,55 L238.1,42.2 L241.3,42.2 L241.3,55 Z M247.7,39 L244.5,39 L244.5,32.6 L247.7,32.6 L247.7,39 Z M263.7,42.2 L254.1,42.2 L254.1,39 L263.7,39 L263.7,42.2 Z M254.1,45.4 L250.9,45.4 L250.9,42.2 L254.1,42.2 L254.1,45.4 Z M260.5,48.6 L254.1,48.6 L254.1,45.4 L260.5,45.4 L260.5,48.6 Z M263.7,51.8 L260.5,51.8 L260.5,48.6 L263.7,48.6 L263.7,51.8 Z M260.5,55 L250.9,55 L250.9,51.8 L260.5,51.8 L260.5,55 Z M127.7,77 L137.3,77 L137.3,80.2 L127.7,80.2 L127.7,89.8 L137.3,89.8 L137.3,93 L124.5,93 L124.5,70.6 L127.7,70.6 L127.7,77 Z M140.5,89.8 L137.3,89.8 L137.3,80.2 L140.5,80.2 L140.5,89.8 Z M150.1,89.8 L146.9,89.8 L146.9,70.6 L150.1,70.6 L150.1,89.8 Z M153.3,93 L150.1,93 L150.1,89.8 L153.3,89.8 L153.3,93 Z M170.9,80.2 L161.3,80.2 L161.3,77 L170.9,77 L170.9,80.2 Z M161.3,89.8 L158.1,89.8 L158.1,80.2 L161.3,80.2 L161.3,89.8 Z M174.1,89.8 L170.9,89.8 L170.9,80.2 L174.1,80.2 L174.1,89.8 Z M170.9,93 L161.3,93 L161.3,89.8 L170.9,89.8 L170.9,93 Z M193.3,80.2 L183.7,80.2 L183.7,77 L193.3,77 L193.3,80.2 Z M183.7,89.8 L180.5,89.8 L180.5,80.2 L183.7,80.2 L183.7,89.8 Z M196.5,96.2 L193.3,96.2 L193.3,93 L183.7,93 L183.7,89.8 L193.3,89.8 L193.3,80.2 L196.5,80.2 L196.5,96.2 Z M193.3,99.4 L183.7,99.4 L183.7,96.2 L193.3,96.2 L193.3,99.4 Z"></path></g></svg></a><style data-emotion-css="b077mo">.css-b077mo{width:64px;height:64px;color:#4a4a4a;color:var(--color-text);margin-bottom:20px;}</style><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="css-b077mo"><g stroke="currentColor" stroke-width="8"><path fill="currentColor" d="M88 236 A54 64 0 0 0 196 236Z M316 236 A54 64 0 0,0 424 236Z"></path><path fill="none" d="M68 335 H444 M77 335 A196 208 0 0 0 435 335 M117 376 H396 M146 350 V402 M200 350 V430 M256 350 V436 M312 350 V430 M366 350 V402 M16 256 A240 240 0 1 0 496 256 A240 240 0 1 0 16 256"></path></g></svg><style data-emotion-css="1hushib">.css-1hushib{display:grid;grid-auto-flow:column;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;color:#777777;}.css-1hushib a{padding:8px;}</style><div class="css-1hushib"><a href="https://twitter.com/chooblarin" target="_blank" rel="noopener noreferrer"><style data-emotion-css="1oaw8ye">.css-1oaw8ye{width:24px;height:24px;color:#4a4a4a;color:var(--color-text);-webkit-transition:color 0.2s linear;transition:color 0.2s linear;}.css-1oaw8ye:hover{color:#983bc9;color:var(--color-primary);}</style><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="css-1oaw8ye"><path fill="currentColor" d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"></path></svg></a><a href="https://github.com/chooblarin" target="_blank" rel="noopener noreferrer"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512" class="css-1oaw8ye"><path fill="currentColor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"></path></svg></a><a href="https://linkedin.com/in/sota-hatakeyama-35bb07120" target="_blank" rel="noopener noreferrer"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" class="css-1oaw8ye"><path fill="currentColor" d="M100.3 448H7.4V148.9h92.9V448zM53.8 108.1C24.1 108.1 0 83.5 0 53.8S24.1 0 53.8 0s53.8 24.1 53.8 53.8-24.1 54.3-53.8 54.3zM448 448h-92.7V302.4c0-34.7-.7-79.2-48.3-79.2-48.3 0-55.7 37.7-55.7 76.7V448h-92.8V148.9h89.1v40.8h1.3c12.4-23.5 42.7-48.3 87.9-48.3 94 0 111.3 61.9 111.3 142.3V448h-.1z"></path></svg></a><a href="mailto:choo.bla.rin@gmail.com"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="css-1oaw8ye"><path fill="currentColor" d="M464 64H48C21.49 64 0 85.49 0 112v288c0 26.51 21.49 48 48 48h416c26.51 0 48-21.49 48-48V112c0-26.51-21.49-48-48-48zm0 48v40.805c-22.422 18.259-58.168 46.651-134.587 106.49-16.841 13.247-50.201 45.072-73.413 44.701-23.208.375-56.579-31.459-73.413-44.701C106.18 199.465 70.425 171.067 48 152.805V112h416zM48 400V214.398c22.914 18.251 55.409 43.862 104.938 82.646 21.857 17.205 60.134 55.186 103.062 54.955 42.717.231 80.509-37.199 103.053-54.947 49.528-38.783 82.032-64.401 104.947-82.653V400H48z"></path></svg></a></div></section></header><style data-emotion-css="14hjwhp">.css-14hjwhp{max-width:740px;line-height:1.5;margin:0 auto;padding:0 20px 100px;}.css-14hjwhp code{background:#e7e7ea;border-radius:4px;padding:2px 6px;font-weight:600;}.css-14hjwhp pre > code{padding:0.8rem;background:#011627;border:2px solid #aaa;font-weight:500;}.css-14hjwhp h1,.css-14hjwhp h2,.css-14hjwhp h3,.css-14hjwhp h4,.css-14hjwhp h5,.css-14hjwhp h6{font-weight:600;margin:2rem 0 1rem;padding-top:0.875rem;}.css-14hjwhp h1{font-size:2.25rem;}.css-14hjwhp h2{line-height:1;font-size:1.85rem;}.css-14hjwhp h3{line-height:1;font-size:1.55rem;}.css-14hjwhp h4{line-height:1;font-size:1.25rem;}.css-14hjwhp h5{line-height:1;font-size:1rem;}.css-14hjwhp h6{line-height:1;font-size:0.875rem;}.css-14hjwhp p{margin:1.5rem 0;}.css-14hjwhp li::marker{color:var(--color-sub-text);}</style><main class="css-14hjwhp"><style data-emotion-css="xf628d">.css-xf628d{line-height:1.5;background:linear-gradient(90deg,#3b9ac9,#983bc9);background-clip:text;-webkit-background-clip:text;-webkit-text-fill-color:transparent;-webkit-box-decoration-break:clone;box-decoration-break:clone;-webkit-box-decoration-break:clone;}</style><h1 class="css-xf628d">ElixirでMIDIファイルをパースする</h1><style data-emotion-css="1nilrd9">.css-1nilrd9{font-size:14px;color:#767676;}</style><p class="css-1nilrd9">August 26, 2017</p><style data-emotion-css="1uwgdjb">.css-1uwgdjb{list-style:none;margin:0 0 72px;}.css-1uwgdjb ul{margin:0;padding:0;}.css-1uwgdjb li{display:inline-block;margin:8px 8px 8px 0;}</style><div class="css-1uwgdjb"><ul><li><style data-emotion-css="nwdtfu">.css-nwdtfu{color:#6b6b6b;-webkit-text-decoration:none;text-decoration:none;background:#eeeeee;font-size:12px;padding:7px 12px;border-radius:2px;}</style><a href="/tags/elixir" class="css-nwdtfu">#Elixir</a></li></ul></div><div><h2>動機</h2>
<p><a href="https://chooblarin.github.io/post/trying-beat-detection/">前回のエントリ</a>では，音楽に合わせて何か絵を動かそうとして beat detection を行いましたが，事前に音に関する情報を分析するアプローチにも挑戦して見たいと思っていたところ，MIDI ファイルなら Elixir の勉強に丁度良いかもと思いついてこの記事を書きました．</p>
<h2>MIDI</h2>
<p>MIDI は音の情報の形式の一つです．MIDI の最も一般的なファイルが SMF(Standard MIDI Format)です．以降，SMF のファイルを単に「MIDI ファイル」と表記します．</p>
<h2>Elixir</h2>
<p>Elixir のパターンマッチは素晴らしいです．バイナリもパターンマッチ出来ます．</p>
<pre><code class="hljs language-elixir">iex(<span class="hljs-number">1</span>)> &#x3C;&#x3C;header :: <span class="hljs-number">8</span>, data :: binary>> = &#x3C;&#x3C;<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>>>
&#x3C;&#x3C;<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>>>
iex(<span class="hljs-number">2</span>)> header
<span class="hljs-number">1</span>
iex(<span class="hljs-number">3</span>)> data
&#x3C;&#x3C;<span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>>></code></pre>
<h2>やってみる</h2>
<p><a href="https://maruyama.breadfish.jp/tech/smf">こちらを</a>参考に MIDI ファイルの中身を覗いてみる．</p>
<p>まず，MIDI ファイルを読み込みます．</p>
<pre><code class="hljs language-elixir">iex(<span class="hljs-number">1</span>) {<span class="hljs-symbol">:ok</span>, data} = File.read <span class="hljs-string">'sample.midi'</span>
{<span class="hljs-symbol">:ok</span>,
 &#x3C;&#x3C;<span class="hljs-number">77</span>, <span class="hljs-number">84</span>, <span class="hljs-number">104</span>, <span class="hljs-number">100</span>, 0, 0, 0, <span class="hljs-number">6</span>, 0, <span class="hljs-number">1</span>, 0, <span class="hljs-number">20</span>, <span class="hljs-number">1</span>, <span class="hljs-number">224</span>, <span class="hljs-number">77</span>, <span class="hljs-number">84</span>, <span class="hljs-number">114</span>, <span class="hljs-number">107</span>, 0, 0, 0,
   <span class="hljs-number">36</span>, 0, <span class="hljs-number">255</span>, <span class="hljs-number">3</span>, <span class="hljs-number">3</span>, <span class="hljs-number">82</span>, <span class="hljs-number">101</span>, <span class="hljs-number">105</span>, 0, <span class="hljs-number">255</span>, <span class="hljs-number">81</span>, <span class="hljs-number">3</span>, <span class="hljs-number">7</span>, <span class="hljs-number">161</span>, <span class="hljs-number">32</span>, 0, <span class="hljs-number">255</span>, <span class="hljs-number">88</span>, <span class="hljs-number">4</span>, <span class="hljs-number">4</span>,
   <span class="hljs-number">2</span>, <span class="hljs-number">24</span>, <span class="hljs-number">8</span>, <span class="hljs-number">143</span>, <span class="hljs-number">143</span>, 0, <span class="hljs-number">255</span>, <span class="hljs-number">88</span>, ...>>}</code></pre>
<p>バイナリさんこんにちわ．MIDI ファイルは必ずヘッダチャンクとトラックチャンクで構成されています．</p>
<h3>ヘッダ</h3>
<p>ヘッダを覗いてみます．ヘッダのチャンク構成は以下のようになっています．括弧の数字はバイト数です．</p>
<p><em>&#x3C;"MThd"> &#x3C;データ長 (4)> &#x3C;フォーマット (2)> &#x3C;トラック数 (2)> &#x3C;時間単位 (2)></em></p>
<p>パターンマッチを使うと一発でヘッダをパース出来ます．</p>
<pre><code class="hljs language-elixir">iex(<span class="hljs-number">2</span>)> &#x3C;&#x3C;<span class="hljs-string">"MThd"</span>, <span class="hljs-number">6</span> :: size(<span class="hljs-number">32</span>), format :: size(<span class="hljs-number">16</span>), num_of_tracks :: size(<span class="hljs-number">16</span>), time_unit :: size(<span class="hljs-number">16</span>), rest :: binary>> = data
&#x3C;&#x3C;<span class="hljs-number">77</span>, <span class="hljs-number">84</span>, <span class="hljs-number">104</span>, <span class="hljs-number">100</span>, 0, 0, 0, <span class="hljs-number">6</span>, 0, <span class="hljs-number">1</span>, 0, <span class="hljs-number">20</span>, <span class="hljs-number">1</span>, <span class="hljs-number">224</span>, <span class="hljs-number">77</span>, <span class="hljs-number">84</span>, <span class="hljs-number">114</span>, <span class="hljs-number">107</span>, 0, 0, 0,
  <span class="hljs-number">36</span>, 0, <span class="hljs-number">255</span>, <span class="hljs-number">3</span>, <span class="hljs-number">3</span>, <span class="hljs-number">82</span>, <span class="hljs-number">101</span>, <span class="hljs-number">105</span>, 0, <span class="hljs-number">255</span>, <span class="hljs-number">81</span>, <span class="hljs-number">3</span>, <span class="hljs-number">7</span>, <span class="hljs-number">161</span>, <span class="hljs-number">32</span>, 0, <span class="hljs-number">255</span>, <span class="hljs-number">88</span>, <span class="hljs-number">4</span>, <span class="hljs-number">4</span>,
  <span class="hljs-number">2</span>, <span class="hljs-number">24</span>, <span class="hljs-number">8</span>, <span class="hljs-number">143</span>, <span class="hljs-number">143</span>, 0, <span class="hljs-number">255</span>, <span class="hljs-number">88</span>, <span class="hljs-number">4</span>, ...>>

iex(<span class="hljs-number">3</span>)> format
<span class="hljs-number">1</span>
iex(<span class="hljs-number">4</span>)> num_of_tracks
<span class="hljs-number">20</span>
iex(<span class="hljs-number">5</span>)> time_unit
<span class="hljs-number">480</span></code></pre>
<p>フォーマット 1，トラック数 20，時間単位 480 のようです．MIDI ファイルのフォーマットは"0", "1", "2"の 3 種類が定義されています．フォーマット 1 はトラック構成を保存したフォーマットです (後にみていくと分かります)．このファイルは 20 トラックの情報を含んでいます．時間単位 480 の意味は，四分音符の分解能が 480 という意味です．よくわからなくても気にせずに進みます．</p>
<p>ここで<code>MidiParser</code>という module を定義しておきます．</p>
<pre><code class="hljs language-elixir"><span class="hljs-class"><span class="hljs-keyword">defmodule</span> <span class="hljs-title">MidiParser</span></span> <span class="hljs-keyword">do</span>

  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">parse_header</span></span>(&#x3C;&#x3C;
  <span class="hljs-string">"MThd"</span>,
  <span class="hljs-number">6</span> :: size(<span class="hljs-number">32</span>),
  format :: size(<span class="hljs-number">16</span>),
  num_of_tracks :: size(<span class="hljs-number">16</span>),
  time_unit :: size(<span class="hljs-number">16</span>),
  _ :: binary>>) <span class="hljs-keyword">do</span>

  IO.puts <span class="hljs-string">"format: <span class="hljs-subst">#{format}</span>"</span>
  IO.puts <span class="hljs-string">"number of tracks: <span class="hljs-subst">#{num_of_tracks}</span>"</span>
  IO.puts <span class="hljs-string">"time unit: <span class="hljs-subst">#{time_unit}</span>"</span>
  <span class="hljs-keyword">end</span>
<span class="hljs-keyword">end</span></code></pre>
<h3>トラック</h3>
<p>トラックのチャンク構成は以下のようになっています．</p>
<p><em>&#x3C;"MTrk"> &#x3C;データ長 (4)> &#x3C;データ本体> &#x3C;...残りのトラックデータ></em></p>
<p><code>MidiParser</code>に各トラックのデータ本体のバイナリを取得する関数を追加します．</p>
<pre><code class="hljs language-elixir"><span class="hljs-class"><span class="hljs-keyword">defmodule</span> <span class="hljs-title">MidiParser</span></span> <span class="hljs-keyword">do</span>

  ...

  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">parse_track</span></span>(data) <span class="hljs-keyword">do</span>
    _parse_track_chunk(data, [])
  <span class="hljs-keyword">end</span>

  <span class="hljs-function"><span class="hljs-keyword">defp</span> <span class="hljs-title">_parse_track_chunk</span></span>(&#x3C;&#x3C;>>, acc) <span class="hljs-keyword">do</span>
    Enum.reverse(acc)
  <span class="hljs-keyword">end</span>

  <span class="hljs-function"><span class="hljs-keyword">defp</span> <span class="hljs-title">_parse_track_chunk</span></span>(&#x3C;&#x3C;
    <span class="hljs-string">"MTrk"</span>,
    length :: size(<span class="hljs-number">32</span>),
    body :: binary - size(length),
    chunks :: binary>>, tracks) <span class="hljs-keyword">do</span>

    _parse_track_chunk(chunks, [body | tracks])
  <span class="hljs-keyword">end</span>
<span class="hljs-keyword">end</span></code></pre>
<p>トラック部分のバイナリを渡して…</p>
<pre><code class="hljs language-elixir">iex(<span class="hljs-number">7</span>)> tracks = MidiParser.parse_track(chunks)</code></pre>
<p><code>tracks</code>はトラックの情報を持った binary のリストです．長さを調べると…</p>
<pre><code class="hljs language-elixir">iex(<span class="hljs-number">8</span>)> length tracks
<span class="hljs-number">20</span></code></pre>
<p>20 トラック分のバイナリを取得出来ました．これからトラック情報をパースしていきます．</p>
<p><em>&#x3C;データ本体></em> は以下のような構成です．</p>
<p><em>&#x3C;デルタタイム> &#x3C;イベント> &#x3C;デルタタイム> &#x3C;イベント> &#x3C;デルタタイム> &#x3C;イベント>...</em></p>
<p>デルタタイムは可変長バイト列です．先頭 1 ビットはフラグで残りの 7 ビット分が数値を表しています．MSB(Most Significant Byte)が 1 のとき，次のバイトもデルタタイムを表現していることになります．この表現方法を解釈する関数を定義してみました．</p>
<pre><code class="hljs language-elixir"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">_extract_variable_length</span></span>(&#x3C;&#x3C;msb :: <span class="hljs-number">1</span>, exp :: <span class="hljs-number">7</span>, _ :: binary>>) <span class="hljs-keyword">when</span> msb == 0 <span class="hljs-keyword">do</span>
  &#x3C;&#x3C;exp :: <span class="hljs-number">7</span>>>
<span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">_extract_variable_length</span></span>(&#x3C;&#x3C;_ :: <span class="hljs-number">1</span>, exp :: <span class="hljs-number">7</span>, rest :: binary>>) <span class="hljs-keyword">do</span>
  <span class="hljs-keyword">next</span> = _extract_variable_length(rest)
  &#x3C;&#x3C; &#x3C;&#x3C;exp :: <span class="hljs-number">7</span>>> :: bitstring, <span class="hljs-keyword">next</span> :: bitstring >>
<span class="hljs-keyword">end</span></code></pre>
<p>これで数値部分の bitstring を抽出出来ました．バイト列に戻して値を抽出します．</p>
<pre><code class="hljs language-elixir"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">extract_variable_length</span></span>(data) <span class="hljs-keyword">do</span>
  bits = _extract_variable_length(data)
  bs = bit_size(bits)
  padding_size = <span class="hljs-number">8</span> - rem(bs, <span class="hljs-number">8</span>)
  byte_data = &#x3C;&#x3C; &#x3C;&#x3C;0 :: size(padding_size)>> :: bitstring, bits :: bitstring >>

  bit_length = padding_size + bs
  &#x3C;&#x3C;length :: size(bit_length)>> = byte_data
  &#x3C;&#x3C;_ :: size(bit_length), chunks :: binary>> = data
  {length, chunks}
<span class="hljs-keyword">end</span></code></pre>
<p>あとはイベントを解釈するコードを追加するのですが，長くなりそうなので続きは後日．
ソースコードは<a href="https://github.com/chooblarin/midi_parser">こちら</a>に置きました．</p>
<p>(追記: 2017/09/18)</p>
<p>MIDI シーケンスに合わせてアニメーションする作品を公開しました．</p>
<p>https://sotahatakeyama.com/#/color-ball-dancing/</p>
<h2>参考</h2>
<ul>
<li><a href="https://www.music.mcgill.ca/~ich/classes/mumt306/StandardMIDIfileformat.html">Standard MIDI-File Format Spec. 1.1, updated</a></li>
<li><a href="https://maruyama.breadfish.jp/tech/smf">SMF(Standard MIDI File)フォーマット解説 | 技術的読み物 | FISH&#x26;BREAD</a></li>
<li><a href="https://zohaib.me/binary-pattern-matching-in-elixir/">Binary pattern matching in Elixir with PNG parsing example</a></li>
</ul>
</div></main><style data-emotion-css="1kv9z39">.css-1kv9z39{width:100%;height:140px;border-top:1px solid #e1e1e1;}</style><footer class="css-1kv9z39"><style data-emotion-css="1gd4ldo">.css-1gd4ldo{width:100%;max-width:740px;height:100%;margin:0 auto;font-size:12px;color:var(--color-sub-text);padding:2rem 0;}</style><div class="css-1gd4ldo"><style data-emotion-css="1erxk2b">.css-1erxk2b{margin:0 20px;}</style><p class="css-1erxk2b">© 2020 chooblarin</p></div></footer></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"postContent":{"title":"ElixirでMIDIファイルをパースする","date":"2017-08-26T23:28:44+09:00","slug":"parsing-midi-by-elixir","tags":["Elixir"],"draft":false,"content":"\u003ch2\u003e動機\u003c/h2\u003e\n\u003cp\u003e\u003ca href=\"https://chooblarin.github.io/post/trying-beat-detection/\"\u003e前回のエントリ\u003c/a\u003eでは，音楽に合わせて何か絵を動かそうとして beat detection を行いましたが，事前に音に関する情報を分析するアプローチにも挑戦して見たいと思っていたところ，MIDI ファイルなら Elixir の勉強に丁度良いかもと思いついてこの記事を書きました．\u003c/p\u003e\n\u003ch2\u003eMIDI\u003c/h2\u003e\n\u003cp\u003eMIDI は音の情報の形式の一つです．MIDI の最も一般的なファイルが SMF(Standard MIDI Format)です．以降，SMF のファイルを単に「MIDI ファイル」と表記します．\u003c/p\u003e\n\u003ch2\u003eElixir\u003c/h2\u003e\n\u003cp\u003eElixir のパターンマッチは素晴らしいです．バイナリもパターンマッチ出来ます．\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-elixir\"\u003eiex(\u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e)\u003e \u0026#x3C;\u0026#x3C;header :: \u003cspan class=\"hljs-number\"\u003e8\u003c/span\u003e, data :: binary\u003e\u003e = \u0026#x3C;\u0026#x3C;\u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e, \u003cspan class=\"hljs-number\"\u003e2\u003c/span\u003e, \u003cspan class=\"hljs-number\"\u003e3\u003c/span\u003e, \u003cspan class=\"hljs-number\"\u003e4\u003c/span\u003e, \u003cspan class=\"hljs-number\"\u003e5\u003c/span\u003e\u003e\u003e\n\u0026#x3C;\u0026#x3C;\u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e, \u003cspan class=\"hljs-number\"\u003e2\u003c/span\u003e, \u003cspan class=\"hljs-number\"\u003e3\u003c/span\u003e, \u003cspan class=\"hljs-number\"\u003e4\u003c/span\u003e, \u003cspan class=\"hljs-number\"\u003e5\u003c/span\u003e\u003e\u003e\niex(\u003cspan class=\"hljs-number\"\u003e2\u003c/span\u003e)\u003e header\n\u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e\niex(\u003cspan class=\"hljs-number\"\u003e3\u003c/span\u003e)\u003e data\n\u0026#x3C;\u0026#x3C;\u003cspan class=\"hljs-number\"\u003e2\u003c/span\u003e, \u003cspan class=\"hljs-number\"\u003e3\u003c/span\u003e, \u003cspan class=\"hljs-number\"\u003e4\u003c/span\u003e, \u003cspan class=\"hljs-number\"\u003e5\u003c/span\u003e\u003e\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003ch2\u003eやってみる\u003c/h2\u003e\n\u003cp\u003e\u003ca href=\"https://maruyama.breadfish.jp/tech/smf\"\u003eこちらを\u003c/a\u003e参考に MIDI ファイルの中身を覗いてみる．\u003c/p\u003e\n\u003cp\u003eまず，MIDI ファイルを読み込みます．\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-elixir\"\u003eiex(\u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e) {\u003cspan class=\"hljs-symbol\"\u003e:ok\u003c/span\u003e, data} = File.read \u003cspan class=\"hljs-string\"\u003e'sample.midi'\u003c/span\u003e\n{\u003cspan class=\"hljs-symbol\"\u003e:ok\u003c/span\u003e,\n \u0026#x3C;\u0026#x3C;\u003cspan class=\"hljs-number\"\u003e77\u003c/span\u003e, \u003cspan class=\"hljs-number\"\u003e84\u003c/span\u003e, \u003cspan class=\"hljs-number\"\u003e104\u003c/span\u003e, \u003cspan class=\"hljs-number\"\u003e100\u003c/span\u003e, 0, 0, 0, \u003cspan class=\"hljs-number\"\u003e6\u003c/span\u003e, 0, \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e, 0, \u003cspan class=\"hljs-number\"\u003e20\u003c/span\u003e, \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e, \u003cspan class=\"hljs-number\"\u003e224\u003c/span\u003e, \u003cspan class=\"hljs-number\"\u003e77\u003c/span\u003e, \u003cspan class=\"hljs-number\"\u003e84\u003c/span\u003e, \u003cspan class=\"hljs-number\"\u003e114\u003c/span\u003e, \u003cspan class=\"hljs-number\"\u003e107\u003c/span\u003e, 0, 0, 0,\n   \u003cspan class=\"hljs-number\"\u003e36\u003c/span\u003e, 0, \u003cspan class=\"hljs-number\"\u003e255\u003c/span\u003e, \u003cspan class=\"hljs-number\"\u003e3\u003c/span\u003e, \u003cspan class=\"hljs-number\"\u003e3\u003c/span\u003e, \u003cspan class=\"hljs-number\"\u003e82\u003c/span\u003e, \u003cspan class=\"hljs-number\"\u003e101\u003c/span\u003e, \u003cspan class=\"hljs-number\"\u003e105\u003c/span\u003e, 0, \u003cspan class=\"hljs-number\"\u003e255\u003c/span\u003e, \u003cspan class=\"hljs-number\"\u003e81\u003c/span\u003e, \u003cspan class=\"hljs-number\"\u003e3\u003c/span\u003e, \u003cspan class=\"hljs-number\"\u003e7\u003c/span\u003e, \u003cspan class=\"hljs-number\"\u003e161\u003c/span\u003e, \u003cspan class=\"hljs-number\"\u003e32\u003c/span\u003e, 0, \u003cspan class=\"hljs-number\"\u003e255\u003c/span\u003e, \u003cspan class=\"hljs-number\"\u003e88\u003c/span\u003e, \u003cspan class=\"hljs-number\"\u003e4\u003c/span\u003e, \u003cspan class=\"hljs-number\"\u003e4\u003c/span\u003e,\n   \u003cspan class=\"hljs-number\"\u003e2\u003c/span\u003e, \u003cspan class=\"hljs-number\"\u003e24\u003c/span\u003e, \u003cspan class=\"hljs-number\"\u003e8\u003c/span\u003e, \u003cspan class=\"hljs-number\"\u003e143\u003c/span\u003e, \u003cspan class=\"hljs-number\"\u003e143\u003c/span\u003e, 0, \u003cspan class=\"hljs-number\"\u003e255\u003c/span\u003e, \u003cspan class=\"hljs-number\"\u003e88\u003c/span\u003e, ...\u003e\u003e}\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eバイナリさんこんにちわ．MIDI ファイルは必ずヘッダチャンクとトラックチャンクで構成されています．\u003c/p\u003e\n\u003ch3\u003eヘッダ\u003c/h3\u003e\n\u003cp\u003eヘッダを覗いてみます．ヘッダのチャンク構成は以下のようになっています．括弧の数字はバイト数です．\u003c/p\u003e\n\u003cp\u003e\u003cem\u003e\u0026#x3C;\"MThd\"\u003e \u0026#x3C;データ長 (4)\u003e \u0026#x3C;フォーマット (2)\u003e \u0026#x3C;トラック数 (2)\u003e \u0026#x3C;時間単位 (2)\u003e\u003c/em\u003e\u003c/p\u003e\n\u003cp\u003eパターンマッチを使うと一発でヘッダをパース出来ます．\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-elixir\"\u003eiex(\u003cspan class=\"hljs-number\"\u003e2\u003c/span\u003e)\u003e \u0026#x3C;\u0026#x3C;\u003cspan class=\"hljs-string\"\u003e\"MThd\"\u003c/span\u003e, \u003cspan class=\"hljs-number\"\u003e6\u003c/span\u003e :: size(\u003cspan class=\"hljs-number\"\u003e32\u003c/span\u003e), format :: size(\u003cspan class=\"hljs-number\"\u003e16\u003c/span\u003e), num_of_tracks :: size(\u003cspan class=\"hljs-number\"\u003e16\u003c/span\u003e), time_unit :: size(\u003cspan class=\"hljs-number\"\u003e16\u003c/span\u003e), rest :: binary\u003e\u003e = data\n\u0026#x3C;\u0026#x3C;\u003cspan class=\"hljs-number\"\u003e77\u003c/span\u003e, \u003cspan class=\"hljs-number\"\u003e84\u003c/span\u003e, \u003cspan class=\"hljs-number\"\u003e104\u003c/span\u003e, \u003cspan class=\"hljs-number\"\u003e100\u003c/span\u003e, 0, 0, 0, \u003cspan class=\"hljs-number\"\u003e6\u003c/span\u003e, 0, \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e, 0, \u003cspan class=\"hljs-number\"\u003e20\u003c/span\u003e, \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e, \u003cspan class=\"hljs-number\"\u003e224\u003c/span\u003e, \u003cspan class=\"hljs-number\"\u003e77\u003c/span\u003e, \u003cspan class=\"hljs-number\"\u003e84\u003c/span\u003e, \u003cspan class=\"hljs-number\"\u003e114\u003c/span\u003e, \u003cspan class=\"hljs-number\"\u003e107\u003c/span\u003e, 0, 0, 0,\n  \u003cspan class=\"hljs-number\"\u003e36\u003c/span\u003e, 0, \u003cspan class=\"hljs-number\"\u003e255\u003c/span\u003e, \u003cspan class=\"hljs-number\"\u003e3\u003c/span\u003e, \u003cspan class=\"hljs-number\"\u003e3\u003c/span\u003e, \u003cspan class=\"hljs-number\"\u003e82\u003c/span\u003e, \u003cspan class=\"hljs-number\"\u003e101\u003c/span\u003e, \u003cspan class=\"hljs-number\"\u003e105\u003c/span\u003e, 0, \u003cspan class=\"hljs-number\"\u003e255\u003c/span\u003e, \u003cspan class=\"hljs-number\"\u003e81\u003c/span\u003e, \u003cspan class=\"hljs-number\"\u003e3\u003c/span\u003e, \u003cspan class=\"hljs-number\"\u003e7\u003c/span\u003e, \u003cspan class=\"hljs-number\"\u003e161\u003c/span\u003e, \u003cspan class=\"hljs-number\"\u003e32\u003c/span\u003e, 0, \u003cspan class=\"hljs-number\"\u003e255\u003c/span\u003e, \u003cspan class=\"hljs-number\"\u003e88\u003c/span\u003e, \u003cspan class=\"hljs-number\"\u003e4\u003c/span\u003e, \u003cspan class=\"hljs-number\"\u003e4\u003c/span\u003e,\n  \u003cspan class=\"hljs-number\"\u003e2\u003c/span\u003e, \u003cspan class=\"hljs-number\"\u003e24\u003c/span\u003e, \u003cspan class=\"hljs-number\"\u003e8\u003c/span\u003e, \u003cspan class=\"hljs-number\"\u003e143\u003c/span\u003e, \u003cspan class=\"hljs-number\"\u003e143\u003c/span\u003e, 0, \u003cspan class=\"hljs-number\"\u003e255\u003c/span\u003e, \u003cspan class=\"hljs-number\"\u003e88\u003c/span\u003e, \u003cspan class=\"hljs-number\"\u003e4\u003c/span\u003e, ...\u003e\u003e\n\niex(\u003cspan class=\"hljs-number\"\u003e3\u003c/span\u003e)\u003e format\n\u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e\niex(\u003cspan class=\"hljs-number\"\u003e4\u003c/span\u003e)\u003e num_of_tracks\n\u003cspan class=\"hljs-number\"\u003e20\u003c/span\u003e\niex(\u003cspan class=\"hljs-number\"\u003e5\u003c/span\u003e)\u003e time_unit\n\u003cspan class=\"hljs-number\"\u003e480\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eフォーマット 1，トラック数 20，時間単位 480 のようです．MIDI ファイルのフォーマットは\"0\", \"1\", \"2\"の 3 種類が定義されています．フォーマット 1 はトラック構成を保存したフォーマットです (後にみていくと分かります)．このファイルは 20 トラックの情報を含んでいます．時間単位 480 の意味は，四分音符の分解能が 480 という意味です．よくわからなくても気にせずに進みます．\u003c/p\u003e\n\u003cp\u003eここで\u003ccode\u003eMidiParser\u003c/code\u003eという module を定義しておきます．\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-elixir\"\u003e\u003cspan class=\"hljs-class\"\u003e\u003cspan class=\"hljs-keyword\"\u003edefmodule\u003c/span\u003e \u003cspan class=\"hljs-title\"\u003eMidiParser\u003c/span\u003e\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003edo\u003c/span\u003e\n\n  \u003cspan class=\"hljs-function\"\u003e\u003cspan class=\"hljs-keyword\"\u003edef\u003c/span\u003e \u003cspan class=\"hljs-title\"\u003eparse_header\u003c/span\u003e\u003c/span\u003e(\u0026#x3C;\u0026#x3C;\n  \u003cspan class=\"hljs-string\"\u003e\"MThd\"\u003c/span\u003e,\n  \u003cspan class=\"hljs-number\"\u003e6\u003c/span\u003e :: size(\u003cspan class=\"hljs-number\"\u003e32\u003c/span\u003e),\n  format :: size(\u003cspan class=\"hljs-number\"\u003e16\u003c/span\u003e),\n  num_of_tracks :: size(\u003cspan class=\"hljs-number\"\u003e16\u003c/span\u003e),\n  time_unit :: size(\u003cspan class=\"hljs-number\"\u003e16\u003c/span\u003e),\n  _ :: binary\u003e\u003e) \u003cspan class=\"hljs-keyword\"\u003edo\u003c/span\u003e\n\n  IO.puts \u003cspan class=\"hljs-string\"\u003e\"format: \u003cspan class=\"hljs-subst\"\u003e#{format}\u003c/span\u003e\"\u003c/span\u003e\n  IO.puts \u003cspan class=\"hljs-string\"\u003e\"number of tracks: \u003cspan class=\"hljs-subst\"\u003e#{num_of_tracks}\u003c/span\u003e\"\u003c/span\u003e\n  IO.puts \u003cspan class=\"hljs-string\"\u003e\"time unit: \u003cspan class=\"hljs-subst\"\u003e#{time_unit}\u003c/span\u003e\"\u003c/span\u003e\n  \u003cspan class=\"hljs-keyword\"\u003eend\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003eend\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003ch3\u003eトラック\u003c/h3\u003e\n\u003cp\u003eトラックのチャンク構成は以下のようになっています．\u003c/p\u003e\n\u003cp\u003e\u003cem\u003e\u0026#x3C;\"MTrk\"\u003e \u0026#x3C;データ長 (4)\u003e \u0026#x3C;データ本体\u003e \u0026#x3C;...残りのトラックデータ\u003e\u003c/em\u003e\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003eMidiParser\u003c/code\u003eに各トラックのデータ本体のバイナリを取得する関数を追加します．\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-elixir\"\u003e\u003cspan class=\"hljs-class\"\u003e\u003cspan class=\"hljs-keyword\"\u003edefmodule\u003c/span\u003e \u003cspan class=\"hljs-title\"\u003eMidiParser\u003c/span\u003e\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003edo\u003c/span\u003e\n\n  ...\n\n  \u003cspan class=\"hljs-function\"\u003e\u003cspan class=\"hljs-keyword\"\u003edef\u003c/span\u003e \u003cspan class=\"hljs-title\"\u003eparse_track\u003c/span\u003e\u003c/span\u003e(data) \u003cspan class=\"hljs-keyword\"\u003edo\u003c/span\u003e\n    _parse_track_chunk(data, [])\n  \u003cspan class=\"hljs-keyword\"\u003eend\u003c/span\u003e\n\n  \u003cspan class=\"hljs-function\"\u003e\u003cspan class=\"hljs-keyword\"\u003edefp\u003c/span\u003e \u003cspan class=\"hljs-title\"\u003e_parse_track_chunk\u003c/span\u003e\u003c/span\u003e(\u0026#x3C;\u0026#x3C;\u003e\u003e, acc) \u003cspan class=\"hljs-keyword\"\u003edo\u003c/span\u003e\n    Enum.reverse(acc)\n  \u003cspan class=\"hljs-keyword\"\u003eend\u003c/span\u003e\n\n  \u003cspan class=\"hljs-function\"\u003e\u003cspan class=\"hljs-keyword\"\u003edefp\u003c/span\u003e \u003cspan class=\"hljs-title\"\u003e_parse_track_chunk\u003c/span\u003e\u003c/span\u003e(\u0026#x3C;\u0026#x3C;\n    \u003cspan class=\"hljs-string\"\u003e\"MTrk\"\u003c/span\u003e,\n    length :: size(\u003cspan class=\"hljs-number\"\u003e32\u003c/span\u003e),\n    body :: binary - size(length),\n    chunks :: binary\u003e\u003e, tracks) \u003cspan class=\"hljs-keyword\"\u003edo\u003c/span\u003e\n\n    _parse_track_chunk(chunks, [body | tracks])\n  \u003cspan class=\"hljs-keyword\"\u003eend\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003eend\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eトラック部分のバイナリを渡して…\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-elixir\"\u003eiex(\u003cspan class=\"hljs-number\"\u003e7\u003c/span\u003e)\u003e tracks = MidiParser.parse_track(chunks)\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e\u003ccode\u003etracks\u003c/code\u003eはトラックの情報を持った binary のリストです．長さを調べると…\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-elixir\"\u003eiex(\u003cspan class=\"hljs-number\"\u003e8\u003c/span\u003e)\u003e length tracks\n\u003cspan class=\"hljs-number\"\u003e20\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e20 トラック分のバイナリを取得出来ました．これからトラック情報をパースしていきます．\u003c/p\u003e\n\u003cp\u003e\u003cem\u003e\u0026#x3C;データ本体\u003e\u003c/em\u003e は以下のような構成です．\u003c/p\u003e\n\u003cp\u003e\u003cem\u003e\u0026#x3C;デルタタイム\u003e \u0026#x3C;イベント\u003e \u0026#x3C;デルタタイム\u003e \u0026#x3C;イベント\u003e \u0026#x3C;デルタタイム\u003e \u0026#x3C;イベント\u003e...\u003c/em\u003e\u003c/p\u003e\n\u003cp\u003eデルタタイムは可変長バイト列です．先頭 1 ビットはフラグで残りの 7 ビット分が数値を表しています．MSB(Most Significant Byte)が 1 のとき，次のバイトもデルタタイムを表現していることになります．この表現方法を解釈する関数を定義してみました．\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-elixir\"\u003e\u003cspan class=\"hljs-function\"\u003e\u003cspan class=\"hljs-keyword\"\u003edef\u003c/span\u003e \u003cspan class=\"hljs-title\"\u003e_extract_variable_length\u003c/span\u003e\u003c/span\u003e(\u0026#x3C;\u0026#x3C;msb :: \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e, exp :: \u003cspan class=\"hljs-number\"\u003e7\u003c/span\u003e, _ :: binary\u003e\u003e) \u003cspan class=\"hljs-keyword\"\u003ewhen\u003c/span\u003e msb == 0 \u003cspan class=\"hljs-keyword\"\u003edo\u003c/span\u003e\n  \u0026#x3C;\u0026#x3C;exp :: \u003cspan class=\"hljs-number\"\u003e7\u003c/span\u003e\u003e\u003e\n\u003cspan class=\"hljs-keyword\"\u003eend\u003c/span\u003e\n\n\u003cspan class=\"hljs-function\"\u003e\u003cspan class=\"hljs-keyword\"\u003edef\u003c/span\u003e \u003cspan class=\"hljs-title\"\u003e_extract_variable_length\u003c/span\u003e\u003c/span\u003e(\u0026#x3C;\u0026#x3C;_ :: \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e, exp :: \u003cspan class=\"hljs-number\"\u003e7\u003c/span\u003e, rest :: binary\u003e\u003e) \u003cspan class=\"hljs-keyword\"\u003edo\u003c/span\u003e\n  \u003cspan class=\"hljs-keyword\"\u003enext\u003c/span\u003e = _extract_variable_length(rest)\n  \u0026#x3C;\u0026#x3C; \u0026#x3C;\u0026#x3C;exp :: \u003cspan class=\"hljs-number\"\u003e7\u003c/span\u003e\u003e\u003e :: bitstring, \u003cspan class=\"hljs-keyword\"\u003enext\u003c/span\u003e :: bitstring \u003e\u003e\n\u003cspan class=\"hljs-keyword\"\u003eend\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eこれで数値部分の bitstring を抽出出来ました．バイト列に戻して値を抽出します．\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-elixir\"\u003e\u003cspan class=\"hljs-function\"\u003e\u003cspan class=\"hljs-keyword\"\u003edef\u003c/span\u003e \u003cspan class=\"hljs-title\"\u003eextract_variable_length\u003c/span\u003e\u003c/span\u003e(data) \u003cspan class=\"hljs-keyword\"\u003edo\u003c/span\u003e\n  bits = _extract_variable_length(data)\n  bs = bit_size(bits)\n  padding_size = \u003cspan class=\"hljs-number\"\u003e8\u003c/span\u003e - rem(bs, \u003cspan class=\"hljs-number\"\u003e8\u003c/span\u003e)\n  byte_data = \u0026#x3C;\u0026#x3C; \u0026#x3C;\u0026#x3C;0 :: size(padding_size)\u003e\u003e :: bitstring, bits :: bitstring \u003e\u003e\n\n  bit_length = padding_size + bs\n  \u0026#x3C;\u0026#x3C;length :: size(bit_length)\u003e\u003e = byte_data\n  \u0026#x3C;\u0026#x3C;_ :: size(bit_length), chunks :: binary\u003e\u003e = data\n  {length, chunks}\n\u003cspan class=\"hljs-keyword\"\u003eend\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eあとはイベントを解釈するコードを追加するのですが，長くなりそうなので続きは後日．\nソースコードは\u003ca href=\"https://github.com/chooblarin/midi_parser\"\u003eこちら\u003c/a\u003eに置きました．\u003c/p\u003e\n\u003cp\u003e(追記: 2017/09/18)\u003c/p\u003e\n\u003cp\u003eMIDI シーケンスに合わせてアニメーションする作品を公開しました．\u003c/p\u003e\n\u003cp\u003ehttps://sotahatakeyama.com/#/color-ball-dancing/\u003c/p\u003e\n\u003ch2\u003e参考\u003c/h2\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://www.music.mcgill.ca/~ich/classes/mumt306/StandardMIDIfileformat.html\"\u003eStandard MIDI-File Format Spec. 1.1, updated\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://maruyama.breadfish.jp/tech/smf\"\u003eSMF(Standard MIDI File)フォーマット解説 | 技術的読み物 | FISH\u0026#x26;BREAD\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://zohaib.me/binary-pattern-matching-in-elixir/\"\u003eBinary pattern matching in Elixir with PNG parsing example\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n"}},"__N_SSG":true},"page":"/post/[slug]","query":{"slug":"parsing-midi-by-elixir"},"buildId":"ss9WLGt4iJuxG5cvUzTbx","nextExport":false,"isFallback":false,"gsp":true}</script><script nomodule="" src="/_next/static/chunks/polyfills-608493d412e67f440912.js"></script><script src="/_next/static/chunks/main-678aa2b69d2ab79ecb76.js" async=""></script><script src="/_next/static/chunks/webpack-e067438c4cf4ef2ef178.js" async=""></script><script src="/_next/static/chunks/framework.1cc9dd07c455eb544511.js" async=""></script><script src="/_next/static/chunks/f1c7a11d82ab5aeae255133ab9a9dd72095cfbe8.e1f58f7275138f941609.js" async=""></script><script src="/_next/static/chunks/be0ee40335aab5b90e46c407218b7ebff3be96c3.f5754105fd8cc37bf292.js" async=""></script><script src="/_next/static/chunks/af34e2db61f97cedc6ebfbaa0d751a83f9f0d9f6.7c780aded457d8a8445d.js" async=""></script><script src="/_next/static/chunks/pages/_app-e01041ccc1fb5d0e6fd2.js" async=""></script><script src="/_next/static/chunks/305bf1217467fbfb8d27f2d195337c27f206dc2e.c6fc4c67fa9d059cb2b1.js" async=""></script><script src="/_next/static/chunks/dc565b348471f1cc9a369b64c164a9c4498f98d4.5a431597bfee0da91e6a.js" async=""></script><script src="/_next/static/chunks/pages/post/%5Bslug%5D-c6759ca9b0a156e6f39c.js" async=""></script><script src="/_next/static/ss9WLGt4iJuxG5cvUzTbx/_buildManifest.js" async=""></script><script src="/_next/static/ss9WLGt4iJuxG5cvUzTbx/_ssgManifest.js" async=""></script></body></html>